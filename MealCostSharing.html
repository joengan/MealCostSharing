<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐費計算機</title>
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#f4f7f6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root { color-scheme: light dark; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            max-width: 1080px;
            margin: 0 auto;
        }
        .container {
            position: relative;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        .item-row.dragging {
            opacity: 0.5;
            background: #cce5ff;
        }
        .item-row input, .item-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .item-row input[type="text"] { flex-grow: 1; min-width: 100px; }
        .item-row input[type="number"] { width: 100px; }
        .discount-logic, .cost-logic {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background-color: transparent;
            color: #d32f2f;
            border: none;
            padding: 8px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover { background-color: #ffeaea; }
        .delete-icon {
            font-size: 18px;
            line-height: 1;
        }
        .delete-fallback {
            font-size: 14px;
            color: white;
            background-color: #f44336;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .add-btn, .calc-btn, .temp-save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .clear-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 6px;
            vertical-align: middle;
        }
        .clear-btn:hover { background: #f0f0f0; }
        .calc-btn { width: 100%; }
        .add-btn:hover, .calc-btn:hover, .temp-save-btn:hover { background-color: #45a049; }
        .temp-save-btn {
            background-color: #008CBA;
            margin-left: 10px;
        }
        .temp-save-btn:hover { background-color: #007ba7; }
        
        #calculation-order-container {
            display: flex;
            gap: 15px;
            padding: 10px;
            border: 1px dashed #aaa;
            border-radius: 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .order-block {
            padding: 15px 25px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            user-select: none;
            border: 2px solid #ccc;
            flex: 0 0 auto;
        }
        .order-block.dragging { opacity: 0.5; background: #b0b0b0; }
        
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4CAF50;
            border-radius: 5px;
        }
        #results h3 { margin-top: 0; }
        #results p { margin: 5px 0; font-size: 1.1em; }
        #results #grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #d32f2f;
            margin-top: 15px;
        }
        .save-feedback {
            color: #4CAF50;
            font-style: italic;
            margin-left: 15px;
            display: none;
        }
        .settings-area { margin-bottom: 15px; }
        .settings-area label { font-weight: bold; }
        .settings-area input { width: 60px; }

        /* 開關切換樣式 */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
        .switch input:checked + .slider { background-color: #2196F3; }
        .switch input:checked + .slider:before { transform: translateX(26px); }

        /* 計算步驟樣式 */
        .steps { margin: 6px 0 10px 0; padding-left: 16px; color: #2f4f4f; }
        .steps li { margin: 2px 0; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 30px 30px 20px 30px;
            border-radius: 10px;
            min-width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 28px;
            cursor: pointer;
        }
        .common-list-block { margin-bottom: 18px; }
        .common-list { list-style: none; padding: 0; margin: 0; }
        .common-list li {
            background: #f7f7f7;
            margin-bottom: 6px;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            justify-content: space-between;
        }
        .common-list li.dragging { opacity: 0.5; background: #e0e0e0; }
        .common-list .delete-btn {
            background: none;
            color: #d32f2f;
            font-size: 18px;
            border: none;
            cursor: pointer;
            padding: 0 6px;
        }
        
        #settings-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 28px;
            cursor: pointer;
            z-index: 20;
        }

        /* 自訂自動完成選單 */
        .autocomplete-container {
            position: relative;
            width: 100%;
            display: inline;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .suggestion-item:hover, .suggestion-item.active {
            background-color: #f0f0f0;
        }
        .suggestion-item.dragging {
            opacity: 0.5;
            background-color: #d0d0d0;
        }
        .suggestion-delete-btn {
            background: transparent;
            border: none;
            color: #d32f2f;
            font-size: 18px;
            cursor: pointer;
            padding: 3px 3px;
            margin-left: 8px;
            border-radius: 4px;
            outline: 1.5px solid transparent;
            transition: outline-color 0.2s;
        }
        .suggestion-delete-btn:hover {
            outline-color: #A292B5;
            transform: scale(1.1);
        }

        /* 拖曳預覽區塊 */
        .placeholder {
            background: #f0f0f0;
            border: 2px dashed #aaa;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .item-row.placeholder {
            margin-bottom: 10px;
        }

        /* 暗黑模式 */
        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e6e6e6; }
            .container { background: #1b1c1f; box-shadow: 0 6px 20px rgba(0,0,0,0.7); }
            h1, h2 { color: #f0f0f0; border-bottom-color: #5aa95e; }

            .section { color: inherit; }
            .item-row { background-color: #22252a; border: 1px solid #3a3f45; box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 1px 6px rgba(0,0,0,0.35); }
            .item-row.dragging { opacity: 0.5; background: #3a3f45; }
            .item-row input, .item-row select { background-color: #2a2e35; color: #e6e6e6; border-color: #4b515a; }
            .item-row input::placeholder { color: #9aa0a6; }
            .item-row:focus-within { outline: 2px solid rgba(97, 218, 251, 0.3); outline-offset: 1px; }

            .delete-btn { color: #ff6b6b; }
            .delete-btn:hover { background-color: rgba(255, 77, 77, 0.12); }

            #calculation-order-container { border-color: #555; background: #191b1d; }
            .order-block { background-color: #2a2e35; border: 2px solid #464c55; color: #e6e6e6; box-shadow: 0 1px 8px rgba(0,0,0,0.35); }
            .order-block.dragging { opacity: 0.8; background: #343a42; }

            #results { background-color: #162217; border-left: 5px solid #5aa95e; box-shadow: 0 1px 8px rgba(0,0,0,0.35) inset; }
            #results h3 { color: #e6e6e6; }
            #results p { color: #e6e6e6; }
            #results #grand-total { color: #ff9a8f; }

            .steps { color: #c0d0d0; }

            .modal { background: rgba(0,0,0,0.55); }
            .modal-content { background: #1e2024; color: #e6e6e6; box-shadow: 0 10px 32px rgba(0,0,0,0.75); }
            .close-modal { color: #e6e6e6; }

            .common-list li { background: #23272d; border: 1px solid #3a3f45; }
            .common-list li.dragging { background: #2f343b; }
            .common-list .delete-btn { color: #ff6b6b; }

            .switch .slider { background-color: #555; }
            .switch input:checked + .slider { background-color: #1b82d1; }

            .add-btn, .calc-btn { background-color: #3c8f43; color: #fff; }
            .add-btn:hover, .calc-btn:hover { background-color: #377f3d; }
            .temp-save-btn { background-color: #1b82d1; }
            .temp-save-btn:hover { background-color: #176faf; }

            #settings-btn { color: #e6e6e6; }

            .clear-btn { color: #c9c9c9; border-color: #555; }
            .clear-btn:hover { background: #2a2e35; }
            
            .autocomplete-suggestions {
                background-color: #2a2e35;
                border-color: #4b515a;
                box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            }
            .suggestion-item:hover, .suggestion-item.active {
                background-color: #343a42;
            }
            .suggestion-item.dragging {
                background-color: #4b515a;
            }
            .suggestion-delete-btn {
                color: #ff6b6b;
            }
            .suggestion-delete-btn:hover {
                background-color: rgba(255, 107, 107, 0.25);
                transform: scale(1.1);
            }
            .placeholder {
                background: #2a2e35;
                border-color: #555;
            }
        }

        /* 手機/小平板優化 */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .container { padding: 16px; }
            h1 { font-size: 1.4rem; }
            h2 { font-size: 1.1rem; }

            .item-row { flex-direction: column; align-items: stretch; gap: 8px; }
            .item-row label { width: 100%; }
            .item-row input, .item-row select { width: 100%; box-sizing: border-box; }
            .discount-logic, .cost-logic { flex-wrap: wrap; }
            .item-row input[type="number"] { width: 100%; }

            .add-btn, .calc-btn, .temp-save-btn { width: 100%; margin: 6px 0 0 0; }
            .delete-btn { align-self: flex-end; padding: 10px 8px; }
            .item-row .delete-btn { width: 100%; align-self: stretch; justify-content: center; }

            .settings-area { display: grid; grid-template-columns: 1fr; row-gap: 8px; }
            .settings-area input { width: 100%; }

            #calculation-order-container { gap: 10px; }
            .order-block { padding: 10px 14px; font-size: 14px; }

            #results p { font-size: 1rem; }

            .modal-content { min-width: auto; width: 92vw; padding: 20px 16px; }

            #settings-btn { top: 12px; right: 12px; font-size: 24px; }

            body { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        }

        /* 桌機版選單微調 */
        @media (min-width: 769px) {
            .suggestion-delete-btn { font-size: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>餐費計算機</h1>

    <div class="section">
        <h2>1. 參與者/用餐人士 (同名人員項目會自動合併計算)
            <button class="clear-btn" title="清空此區" onclick="clearPersonnel()">
                <span class="clear-icon" aria-label="清空" role="img">🧹</span>
                <span class="clear-fallback" style="display:none;">清空</span>
            </button>
        </h2>
        <div id="personnel-list"></div>
        <button class="add-btn" onclick="addPersonnel()">新增項目</button>
    </div>

    <div class="section">
        <h2>2. 均分費用區
            <button class="clear-btn" title="清空此區" onclick="clearSharedCosts()">
                <span class="clear-icon" aria-label="清空" role="img">🧹</span>
                <span class="clear-fallback" style="display:none;">清空</span>
            </button>
        </h2>
        <div id="shared-costs-list"></div>
        <button class="add-btn" onclick="addSharedCost()">新增均分費用</button>
    </div>

    <div class="section">
        <h2>3. 共同優惠區
            <button class="clear-btn" title="清空此區" onclick="clearSharedDiscounts()">
                <span class="clear-icon" aria-label="清空" role="img">🧹</span>
                <span class="clear-fallback" style="display:none;">清空</span>
            </button>
        </h2>
        <div id="shared-discounts-list"></div>
        <button class="add-btn" onclick="addSharedDiscount()">新增共同優惠</button>
    </div>
    
    <div class="section">
        <h2>4. 計算方式 (可拖曳調整順序)</h2>
        <div id="calculation-order-container"></div>
    </div>

    <div class="section">
        <h2>5. 進行計算</h2>
        <div class="settings-area">
            <label>進位方式:
                <select id="rounding-method" onchange="updateSettings('roundingMethod', this.value)">
                    <option value="round">四捨五入</option>
                    <option value="ceil">上捨入</option>
                    <option value="floor">下捨入</option>
                </select>
            </label>
            <label style="margin-left: 18px;">小數位數: 
                <input type="number" id="decimal-places" min="0" max="10" 
                       oninput="updateSettings('decimalPlaces', parseInt(this.value))">
            </label>
            <span style="margin-left: 18px;">
                <span style="font-weight:bold; vertical-align: middle;">顯示計算過程</span>
                <label class="switch" style="margin-left:8px;">
                    <input type="checkbox" id="show-steps-toggle" onchange="updateSettings('showSteps', this.checked)">
                    <span class="slider"></span>
                </label>
            </span>
        </div>
        <button class="calc-btn" onclick="calculate()">計算</button>
        <div id="results">
            <h3>計算結果</h3>
            <ul id="calc-steps" class="steps" style="display:none;"></ul>
            <div id="result-details">-- 等待計算 --</div>
            <p id="grand-total"></p>
        </div>
    </div>

    <div id="settings-btn" title="偏好設定">⚙️</div>
    <div id="common-info-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-modal" title="關閉">&times;</span>
        <h2>偏好設定</h2>
        <div class="common-list-block">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
                <span style="font-weight:bold;">刪除「項目」時確認</span>
                <label class="switch">
                    <input type="checkbox" id="confirm-delete-item-toggle" onchange="updateSettings('confirmDeleteItem', this.checked)">
                    <span class="slider"></span>
                </label>
                <small>刪除「人員、均分費用、共同優惠」項目時，跳出確認提示。</small>
            </div>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
                <span style="font-weight:bold;">刪除「常用選項」時確認</span>
                <label class="switch">
                    <input type="checkbox" id="confirm-delete-option-toggle" onchange="updateSettings('confirmDeleteOption', this.checked)">
                    <span class="slider"></span>
                </label>
                <small>從輸入建議選單中刪除常用名稱時，跳出確認提示。</small>
            </div>
            <div id="pwa-install-area" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span style="font-weight:bold;">應用程式</span>
                <label>
                    <button id="pwa-install-btn" class="add-btn" style="width:auto;">安裝</button>
                </label>
            </div>
        </div>
      </div>
    </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

// PWA 安裝提示按鈕邏輯
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  // 不阻止預設行為
  deferredPrompt = e;
  // 僅在設定畫面顯示安裝按鈕
  const installArea = document.getElementById('pwa-install-area');
  if (installArea) installArea.style.display = '';
});

// 點擊安裝按鈕時觸發安裝流程
document.addEventListener('DOMContentLoaded', () => {
  const installBtn = document.getElementById('pwa-install-btn');
  if (installBtn) {
    installBtn.onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        // 等待用戶回應
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        // 隱藏安裝按鈕
        document.getElementById('pwa-install-area').style.display = 'none';
      }
    };
  }

  // 檢查是否支援 PWA 安裝
  function checkPWAInstallable() {
    // 已安裝或不支援時隱藏
    const installArea = document.getElementById('pwa-install-area');
    if (!window.matchMedia('(display-mode: browser)').matches) {
      // 已安裝或在獨立模式
      if (installArea) installArea.style.display = 'none';
      return;
    }
    // 若 beforeinstallprompt 尚未觸發，也隱藏
    if (!deferredPrompt && installArea) installArea.style.display = 'none';
  }

  // 初始檢查
  checkPWAInstallable();
  // 進入設定畫面時再檢查
  document.getElementById('settings-btn').onclick = () => {
    document.getElementById('common-info-modal').style.display = 'flex';
    checkPWAInstallable();
  };
});
</script>

<script>
/**
 * 餐費計算機
 * - 管理人員、均分費用、共同優惠，並依自訂順序進行計算。
 * - 使用 localStorage（UNIFIED_STORAGE_KEY）儲存整體資料（appData + commonInfo）。
 * - 自動完成建議：維護常用清單，可拖曳排序與刪除。
 */

// 常數與預設資料
/** localStorage 統一儲存鍵 */
const UNIFIED_STORAGE_KEY = 'MealCostSharingData';
/** 舊版儲存鍵（資料遷移） */
const OLD_STORAGE_KEY = 'splitBillCalculatorData_v2';
/** 舊版常用清單儲存鍵（資料遷移） */
const OLD_COMMON_KEY = 'splitBillCommonInfo_v1';

/** 預設資料結構 */
const defaultMealCostData = {
    appData: {
        personnel: [{ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }],
        sharedCosts: [],
        sharedDiscounts: [],
        calculationOrder: ['personnel', 'sharedDiscounts', 'sharedCosts'],
        settings: {
            decimalPlaces: 1,
            roundingMethod: 'round',
            showSteps: false,
            confirmDeleteItem: true,
            confirmDeleteOption: true
        }
    },
    commonInfo: {
        person: [],
        cost: [],
        discount: []
    }
};

/** 目前的應用資料（啟動時載入或遷移） */
let mealCostData = loadInitialData();


/**
 * 自訂自動完成建議清單
 * - 依輸入值即時篩選建議
 * - 支援鍵盤操作（上下、Enter、Esc）
 * - 支援在清單內拖曳排序與刪除
 */
class CustomAutocomplete {
    /**
     * @param {HTMLInputElement} inputElement 文字輸入框
     * @param {'person'|'cost'|'discount'} type 建議清單類別
     */
    constructor(inputElement, type) {
        this.input = inputElement;
        this.type = type;
        this.container = this.input.parentElement;
        this.suggestionsContainer = null;
        this.activeSuggestionIndex = -1;
        this.draggedItem = null;
        this.dragStartIndex = -1;
        this.isDragging = false;
        this.clickTimeout = null;
        this.placeholder = null;
        this.init();
    }

    /** 綁定輸入、焦點、鍵盤與點擊事件 */
    init() {
        this.input.addEventListener('focus', () => this.showSuggestions());
        this.input.addEventListener('input', () => this.showSuggestions());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) this.hideSuggestions();
        });
    }

    /** 顯示建議清單，並根據輸入值篩選 */
    showSuggestions() {
        const value = this.input.value.toLowerCase();
        const suggestions = mealCostData.commonInfo[this.type].filter(item => item.toLowerCase().includes(value));

        if (!this.suggestionsContainer) {
            this.suggestionsContainer = document.createElement('div');
            this.suggestionsContainer.className = 'autocomplete-suggestions';
            this.container.appendChild(this.suggestionsContainer);
        }

        this.suggestionsContainer.innerHTML = '';
        this.activeSuggestionIndex = -1;

        if (suggestions.length === 0) {
            this.hideSuggestions();
            return;
        }
        this.suggestionsContainer.style.display = 'block';

        suggestions.forEach((item) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'suggestion-item';
            itemDiv.dataset.value = item;
            
            const textSpan = document.createElement('span');
            textSpan.textContent = item;
            itemDiv.appendChild(textSpan);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'suggestion-delete-btn';
            deleteBtn.innerHTML = '✖️';
            deleteBtn.title = '刪除此常用項目';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const originalIndex = mealCostData.commonInfo[this.type].indexOf(item);
                if (originalIndex > -1) {
                    deleteCommonInfoItem(this.type, originalIndex, () => this.showSuggestions());
                }
            });
            itemDiv.appendChild(deleteBtn);

            itemDiv.addEventListener('mousedown', (e) => {
                if (e.target === deleteBtn) return;
                e.preventDefault();

                this.isDragging = false;
                this.draggedItem = itemDiv;
                this.dragStartIndex = mealCostData.commonInfo[this.type].indexOf(item);

                this.clickTimeout = setTimeout(() => {
                    this.isDragging = true;
                    this.draggedItem.classList.add('dragging');
                    this.suggestionsContainer.style.cursor = 'grabbing';
                    
                    this.placeholder = document.createElement('div');
                    this.placeholder.className = 'suggestion-item placeholder';
                    const rect = this.draggedItem.getBoundingClientRect();
                    this.placeholder.style.height = `${rect.height}px`;
                }, 200);

                const onMouseMove = (moveE) => {
                    if (this.isDragging) this.handleDrag(moveE);
                };
                const onMouseUp = () => {
                    clearTimeout(this.clickTimeout);
                    if (!this.isDragging) {
                        this.selectSuggestion(item);
                    } else {
                        this.draggedItem.classList.remove('dragging');
                        this.suggestionsContainer.style.cursor = '';
                        if (this.placeholder && this.placeholder.parentNode) {
                            this.placeholder.parentNode.replaceChild(this.draggedItem, this.placeholder);
                        }
                        this.updateCommonInfoOrder();
                    }
                    this.draggedItem = null;
                    if (this.placeholder) {
                        if (this.placeholder.parentNode) this.placeholder.remove();
                        this.placeholder = null;
                    }
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            this.suggestionsContainer.appendChild(itemDiv);
        });
    }

    /**
     * 拖曳中：移動預留位置
     * @param {MouseEvent} e 滑鼠事件
     */
    handleDrag(e) {
        if (!this.draggedItem || !this.placeholder) return;
        const afterElement = this.getDragAfterElement(this.suggestionsContainer, e.clientY);
        if (afterElement == null) this.suggestionsContainer.appendChild(this.placeholder);
        else this.suggestionsContainer.insertBefore(this.placeholder, afterElement);
    }
    
    /**
     * 取得清單中的插入參考元素
     * @param {HTMLElement} container 容器
     * @param {number} y 目前滑鼠 Y 座標
     * @returns {HTMLElement|null} 參考元素
     */
    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.suggestion-item:not(.dragging):not(.placeholder)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset, element: child };
            return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    /** 將清單新順序回寫至 commonInfo 並儲存 */
    updateCommonInfoOrder() {
        const newOrder = [...this.suggestionsContainer.querySelectorAll('.suggestion-item:not(.placeholder)')]
            .map(item => item.dataset.value);
        const originalArray = mealCostData.commonInfo[this.type];
        const newArray = newOrder.concat(originalArray.filter(item => !newOrder.includes(item)));
        mealCostData.commonInfo[this.type] = newArray;
        saveData();
    }
    
    /**
     * 選取建議值並觸發 change 事件
     * @param {string} value 選取文字
     */
    selectSuggestion(value) {
        this.input.value = value;
        this.hideSuggestions();
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
    }

    /** 隱藏建議清單 */
    hideSuggestions() {
        if (this.suggestionsContainer) this.suggestionsContainer.style.display = 'none';
    }

    /**
     * 鍵盤操作：上下選取、Enter 確認、Esc 關閉
     * @param {KeyboardEvent} e 鍵盤事件
     */
    handleKeydown(e) {
        if (!this.suggestionsContainer || this.suggestionsContainer.style.display === 'none') return;
        const items = this.suggestionsContainer.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.activeSuggestionIndex = (this.activeSuggestionIndex + 1) % items.length;
                this.updateActiveSuggestion(items);
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.activeSuggestionIndex = (this.activeSuggestionIndex - 1 + items.length) % items.length;
                this.updateActiveSuggestion(items);
                break;
            case 'Enter':
                e.preventDefault();
                if (this.activeSuggestionIndex > -1) {
                    this.selectSuggestion(items[this.activeSuggestionIndex].dataset.value);
                }
                break;
            case 'Escape':
                this.hideSuggestions();
                break;
        }
    }
    
    /**
     * 更新鍵盤高亮的建議項目並確保可見
     * @param {NodeListOf<HTMLElement>} items 建議集合
     */
    updateActiveSuggestion(items) {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === this.activeSuggestionIndex);
        });
        items[this.activeSuggestionIndex].scrollIntoView({ block: 'nearest' });
    }
}


/**
 * 將資料儲存至 localStorage
 * @returns {void}
 */
function saveData() { 
    try { 
        localStorage.setItem(UNIFIED_STORAGE_KEY, JSON.stringify(mealCostData)); 
    } catch (e) { 
        console.error("Error saving unified data:", e); 
    } 
}

/**
 * 載入啟動資料：
 * 1) 讀取統一鍵；
 * 2) 若無則嘗試自舊版鍵遷移；
 * 3) 失敗時回傳預設值。
 * 同時合併預設結構，確保新增欄位存在。
 * @returns {{appData: any, commonInfo: any}} 初始化後的資料物件
 */
function loadInitialData() {
    const unifiedDataStr = localStorage.getItem(UNIFIED_STORAGE_KEY);
    if (unifiedDataStr) {
        try {
            const loadedData = JSON.parse(unifiedDataStr);
            const defaultAppData = defaultMealCostData.appData;
            const defaultCommonInfo = defaultMealCostData.commonInfo;
            const finalAppData = {
                ...defaultAppData,
                ...(loadedData.appData || {}),
                settings: { ...defaultAppData.settings, ...(loadedData.appData ? loadedData.appData.settings : {}) }
            };
            const finalCommonInfo = { ...defaultCommonInfo, ...(loadedData.commonInfo || {}) };
            return { appData: finalAppData, commonInfo: finalCommonInfo };
        } catch (e) {
            console.error("Error parsing unified data, falling back to defaults.", e);
            return JSON.parse(JSON.stringify(defaultMealCostData));
        }
    }

    const oldAppDataStr = localStorage.getItem(OLD_STORAGE_KEY);
    const oldCommonInfoStr = localStorage.getItem(OLD_COMMON_KEY);

    if (oldAppDataStr) {
        console.log("Migrating data from old version...");
        let migratedData = JSON.parse(JSON.stringify(defaultMealCostData));

        try {
            const savedAppData = JSON.parse(oldAppDataStr);
            if (savedAppData.sharedCosts && savedAppData.sharedCosts.length > 0) {
                savedAppData.sharedCosts.forEach(sc => {
                    if (typeof sc.amount !== 'undefined' && typeof sc.cost === 'undefined') {
                        sc.cost = { type: 'amount', value: sc.amount, cap: 0 };
                        delete sc.amount;
                    }
                });
            }
            if (savedAppData.settings && typeof savedAppData.settings.confirmDelete !== 'undefined') {
                savedAppData.settings.confirmDeleteItem = savedAppData.settings.confirmDelete;
                savedAppData.settings.confirmDeleteOption = savedAppData.settings.confirmDelete;
                delete savedAppData.settings.confirmDelete;
            }
            migratedData.appData = {
                ...migratedData.appData,
                ...savedAppData,
                settings: { ...migratedData.appData.settings, ...(savedAppData.settings || {}) }
            };
        } catch (e) {
            console.error("Error parsing old appData during migration:", e);
        }

        if (oldCommonInfoStr) {
            try {
                const savedCommonInfo = JSON.parse(oldCommonInfoStr);
                migratedData.commonInfo = {
                    person: savedCommonInfo.person || [],
                    cost: savedCommonInfo.cost || [],
                    discount: savedCommonInfo.discount || []
                };
            } catch (e) {
                console.error("Error parsing old commonInfo during migration:", e);
            }
        }
        
        try {
            localStorage.setItem(UNIFIED_STORAGE_KEY, JSON.stringify(migratedData));
            localStorage.removeItem(OLD_STORAGE_KEY);
            localStorage.removeItem(OLD_COMMON_KEY);
        } catch (e) {
            console.error("Could not save migrated data or remove old keys.", e);
        }

        return migratedData;
    }

    return JSON.parse(JSON.stringify(defaultMealCostData));
}


/**
 * 重新渲染整體畫面（人員/費用/優惠/順序/設定）
 * @returns {void}
 */
function render() {
    renderPersonnel();
    renderSharedCosts();
    renderSharedDiscounts();
    renderCalculationOrder();
    renderSettings();
}

/**
 * 渲染人員清單與事件綁定
 * @returns {void}
 */
function renderPersonnel() {
    const list = document.getElementById('personnel-list');
    list.innerHTML = '';
    mealCostData.appData.personnel.forEach(p => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-personnel';
        div.dataset.id = p.id;
        div.draggable = true;
        div.innerHTML = `
            <label>姓名: <div class="autocomplete-container"><input type="text" value="${p.name}" class="person-name-input" data-id="${p.id}"></div></label>
            <label>餐費: <input type="number" min="0" value="${p.mealCost}" class="person-mealcost-input" data-id="${p.id}"></label>
            <div class="discount-logic">
                <label>折扣:</label>
                <select class="person-discount-type" data-id="${p.id}">
                    <option value="amount" ${p.discount.type === 'amount' ? 'selected' : ''}>金額</option>
                    <option value="percent" ${p.discount.type === 'percent' ? 'selected' : ''}>比例(%)</option>
                </select>
                <input type="number" min="0" value="${p.discount.value}" class="person-discount-value" data-id="${p.id}">
                ${p.discount.type === 'percent' ? `<label>上限: <input type="number" min="0" value="${p.discount.cap}" class="person-discount-cap" data-id="${p.id}"></label><small>(0為無上限)</small>` : ''}
            </div>
            <button class="delete-btn" title="刪除此人員" onclick="deletePersonnel(${p.id})">
                <span class="delete-icon" aria-label="刪除" role="img">🗑️</span>
                <span class="delete-fallback" style="display:none;">刪除</span>
            </button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.person-name-input').forEach(input => {
        new CustomAutocomplete(input, 'person');
        input.onchange = function() {
            const id = parseInt(this.dataset.id);
            updatePersonnel(id, 'name', this.value);
            addCommonInfo('person', this.value);
        };
    });
    list.querySelectorAll('.person-mealcost-input').forEach(input => {
        input.oninput = function() {
            updatePersonnel(parseInt(this.dataset.id), 'mealCost', parseFloat(this.value) || 0);
        };
    });
    list.querySelectorAll('.person-discount-type').forEach(sel => {
        sel.onchange = function() {
            updatePersonnel(parseInt(this.dataset.id), 'discount.type', this.value);
            renderPersonnel();
        };
    });
    list.querySelectorAll('.person-discount-value').forEach(input => {
        input.oninput = function() {
            updatePersonnel(parseInt(this.dataset.id), 'discount.value', parseFloat(this.value) || 0);
        };
    });
    list.querySelectorAll('.person-discount-cap').forEach(input => {
        input.oninput = function() {
            updatePersonnel(parseInt(this.dataset.id), 'discount.cap', parseFloat(this.value) || 0);
        };
    });
}

/**
 * 渲染均分費用清單與事件綁定
 * @returns {void}
 */
function renderSharedCosts() {
    const list = document.getElementById('shared-costs-list');
    list.innerHTML = '';
    mealCostData.appData.sharedCosts.forEach(sc => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-cost';
        div.dataset.id = sc.id;
        div.draggable = true;
        div.innerHTML = `
            <label>費用名稱: <div class="autocomplete-container"><input type="text" value="${sc.name}" class="shared-cost-name-input" data-id="${sc.id}"></div></label>
            <div class="cost-logic">
                <label>費用:</label>
                <select class="shared-cost-type-input" data-id="${sc.id}">
                    <option value="amount" ${sc.cost.type === 'amount' ? 'selected' : ''}>金額</option>
                    <option value="percent" ${sc.cost.type === 'percent' ? 'selected' : ''}>比例(%)</option>
                </select>
                <input type="number" min="0" value="${sc.cost.value}" class="shared-cost-value-input" data-id="${sc.id}">
                ${sc.cost.type === 'percent' ? `<label>上限: <input type="number" min="0" value="${sc.cost.cap}" class="shared-cost-cap-input" data-id="${sc.id}"></label><small>(0為無上限)</small>` : ''}
            </div>
            <label>攤分方式:
                <select class="shared-cost-method-input" data-id="${sc.id}">
                    <option value="evenly" ${sc.method === 'evenly' ? 'selected' : ''}>平均攤分</option>
                    <option value="proportionally" ${sc.method === 'proportionally' ? 'selected' : ''}>按餐費比例</option>
                </select>
            </label>
            <button class="delete-btn" title="刪除此費用" onclick="deleteSharedCost(${sc.id})">
                <span class="delete-icon" aria-label="刪除" role="img">🗑️</span>
                <span class="delete-fallback" style="display:none;">刪除</span>
            </button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.shared-cost-name-input').forEach(input => {
        new CustomAutocomplete(input, 'cost');
        input.addEventListener('change', function() {
            updateSharedCost(parseInt(this.dataset.id), 'name', this.value);
        });
    });
    list.querySelectorAll('.shared-cost-type-input').forEach(input => {
        input.addEventListener('change', function() {
            updateSharedCost(parseInt(this.dataset.id), 'cost.type', this.value);
        });
    });
    list.querySelectorAll('.shared-cost-value-input').forEach(input => {
        input.addEventListener('input', function() {
            updateSharedCost(parseInt(this.dataset.id), 'cost.value', parseFloat(this.value) || 0);
        });
    });
    list.querySelectorAll('.shared-cost-cap-input').forEach(input => {
        input.addEventListener('input', function() {
            updateSharedCost(parseInt(this.dataset.id), 'cost.cap', parseFloat(this.value) || 0);
        });
    });
    list.querySelectorAll('.shared-cost-method-input').forEach(input => {
        input.addEventListener('change', function() {
            updateSharedCost(parseInt(this.dataset.id), 'method', this.value);
        });
    });
}

/**
 * 渲染共同優惠清單與事件綁定
 * @returns {void}
 */
function renderSharedDiscounts() {
    const list = document.getElementById('shared-discounts-list');
    list.innerHTML = '';
    mealCostData.appData.sharedDiscounts.forEach(sd => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-discount';
        div.dataset.id = sd.id;
        div.draggable = true;
        div.innerHTML = `
            <label>優惠名稱: <div class="autocomplete-container"><input type="text" value="${sd.name}" class="shared-discount-name-input" data-id="${sd.id}"></div></label>
            <div class="discount-logic">
                <label>優惠:</label>
                <select class="shared-discount-type-input" data-id="${sd.id}">
                    <option value="amount" ${sd.discount.type === 'amount' ? 'selected' : ''}>金額</option>
                    <option value="percent" ${sd.discount.type === 'percent' ? 'selected' : ''}>比例(%)</option>
                </select>
                <input type="number" min="0" value="${sd.discount.value}" class="shared-discount-value-input" data-id="${sd.id}">
                 ${sd.discount.type === 'percent' ? `<label>上限: <input type="number" min="0" value="${sd.discount.cap}" class="shared-discount-cap-input" data-id="${sd.id}"></label><small>(0為無上限)</small>` : ''}
            </div>
            <label>攤分方式:
                <select class="shared-discount-method-input" data-id="${sd.id}">
                    <option value="evenly" ${sd.method === 'evenly' ? 'selected' : ''}>平均攤分</option>
                    <option value="proportionally" ${sd.method === 'proportionally' ? 'selected' : ''}>按餐費比例</option>
                </select>
            </label>
            <button class="delete-btn" title="刪除此優惠" onclick="deleteSharedDiscount(${sd.id})">
                <span class="delete-icon" aria-label="刪除" role="img">🗑️</span>
                <span class="delete-fallback" style="display:none;">刪除</span>
            </button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.shared-discount-name-input').forEach(input => {
        new CustomAutocomplete(input, 'discount');
        input.addEventListener('change', function() {
            updateSharedDiscount(parseInt(this.dataset.id), 'name', this.value);
        });
    });
    list.querySelectorAll('.shared-discount-type-input').forEach(input => {
        input.addEventListener('change', function() {
            updateSharedDiscount(parseInt(this.dataset.id), 'discount.type', this.value);
        });
    });
    list.querySelectorAll('.shared-discount-value-input').forEach(input => {
        input.addEventListener('input', function() {
            updateSharedDiscount(parseInt(this.dataset.id), 'discount.value', parseFloat(this.value) || 0);
        });
    });
    list.querySelectorAll('.shared-discount-cap-input').forEach(input => {
        input.addEventListener('input', function() {
            updateSharedDiscount(parseInt(this.dataset.id), 'discount.cap', parseFloat(this.value) || 0);
        });
    });
    list.querySelectorAll('.shared-discount-method-input').forEach(input => {
        input.addEventListener('change', function() {
            updateSharedDiscount(parseInt(this.dataset.id), 'method', this.value);
        });
    });
}


/**
 * 為指定清單啟用拖曳排序，並在 drop 後更新對應資料順序
 * @param {string} listSelector 容器選擇器
 * @param {Array} dataArray 對應資料陣列參考
 * @returns {void}
 */
function setupDrag(listSelector, dataArray) {
    const list = document.querySelector(listSelector);
    let draggedItem = null;
    let placeholder = null;

    list.addEventListener('dragstart', (e) => {
        if (e.target.closest('.item-row')) {
            draggedItem = e.target.closest('.item-row');
            placeholder = document.createElement('div');
            placeholder.className = 'item-row placeholder';
            const rect = draggedItem.getBoundingClientRect();
            placeholder.style.height = `${rect.height}px`;
            setTimeout(() => draggedItem.classList.add('dragging'), 0);
        }
    });

    list.addEventListener('dragend', () => {
        if (draggedItem) draggedItem.classList.remove('dragging');
        if (placeholder && placeholder.parentNode) placeholder.remove();
        draggedItem = null;
        placeholder = null;
    });

    list.addEventListener('dragover', e => {
        e.preventDefault();
        if (!placeholder) return;
        const afterElement = getDragAfterElementForRow(list, e.clientY);
        if (afterElement == null) list.appendChild(placeholder);
        else list.insertBefore(placeholder, afterElement);
    });

    list.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem || !placeholder || !placeholder.parentNode) return;
        placeholder.parentNode.replaceChild(draggedItem, placeholder);
        placeholder = null;
        
        const newOrder = [...list.querySelectorAll('.item-row')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => dataArray.find(item => item.id === id)).filter(Boolean);
        
        if (dataArray === mealCostData.appData.personnel) mealCostData.appData.personnel = newArr;
        else if (dataArray === mealCostData.appData.sharedCosts) mealCostData.appData.sharedCosts = newArr;
        else if (dataArray === mealCostData.appData.sharedDiscounts) mealCostData.appData.sharedDiscounts = newArr;
        
        saveData();
    });
}

/**
 * 取得垂直列表中拖曳插入位置參考元素
 * @param {HTMLElement} container 容器
 * @param {number} y 滑鼠 Y 座標
 * @returns {HTMLElement|null} 參考元素
 */
function getDragAfterElementForRow(container, y) {
    const draggableElements = [...container.querySelectorAll('.item-row:not(.dragging):not(.placeholder)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, element: child };
        return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/**
 * 渲染計算順序區塊（水平拖曳）
 * @returns {void}
 */
function renderCalculationOrder() {
    const container = document.getElementById('calculation-order-container');
    container.innerHTML = '';
    const nameMap = {
        personnel: '(+) 人員區',
        sharedDiscounts: '(-) 共同優惠區',
        sharedCosts: '(+) 均分費用區'
    };
    mealCostData.appData.calculationOrder.forEach(key => {
        const div = document.createElement('div');
        div.className = 'order-block';
        div.dataset.key = key;
        div.draggable = true;
        div.textContent = nameMap[key];
        container.appendChild(div);
    });
}

/**
 * 渲染設定區（進位方式、小數位數、顯示步驟、刪除確認）
 * @returns {void}
 */
function renderSettings() {
    document.getElementById('decimal-places').value = mealCostData.appData.settings.decimalPlaces;
    document.getElementById('rounding-method').value = mealCostData.appData.settings.roundingMethod || 'round';
    document.getElementById('show-steps-toggle').checked = !!mealCostData.appData.settings.showSteps;
    document.getElementById('confirm-delete-item-toggle').checked = !!mealCostData.appData.settings.confirmDeleteItem;
    document.getElementById('confirm-delete-option-toggle').checked = !!mealCostData.appData.settings.confirmDeleteOption;
    document.getElementById('calc-steps').style.display = mealCostData.appData.settings.showSteps ? 'block' : 'none';
}

/**
 * 取得水平拖曳時的插入參考元素
 * @param {HTMLElement} container 容器
 * @param {number} x 滑鼠 X 座標
 * @returns {HTMLElement|null} 參考元素
 */
function getDragAfterElementForHorizontal(container, x) {
    const draggableElements = [...container.querySelectorAll('.order-block:not(.dragging):not(.placeholder)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) return { offset, element: child };
        return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/**
 * 啟用計算順序區塊的拖曳排序
 * @returns {void}
 */
function setupOrderDragAndDrop() {
    const container = document.getElementById('calculation-order-container');
    let draggedItem = null;
    let placeholder = null;

    container.addEventListener('dragstart', e => {
        if (e.target.classList.contains('order-block')) {
            draggedItem = e.target;
            placeholder = document.createElement('div');
            placeholder.className = 'order-block placeholder';
            const rect = draggedItem.getBoundingClientRect();
            placeholder.style.width = `${rect.width}px`;
            placeholder.style.height = `${rect.height}px`;
            setTimeout(() => draggedItem.classList.add('dragging'), 0);
        }
    });

    container.addEventListener('dragend', () => {
        if (draggedItem) draggedItem.classList.remove('dragging');
        if (placeholder && placeholder.parentNode) placeholder.remove();
        draggedItem = null;
        placeholder = null;
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        if (!placeholder) return;
        const afterElement = getDragAfterElementForHorizontal(container, e.clientX);
        if (afterElement == null) container.appendChild(placeholder);
        else container.insertBefore(placeholder, afterElement);
    });
    
    container.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem || !placeholder || !placeholder.parentNode) return;
        placeholder.parentNode.replaceChild(draggedItem, placeholder);
        placeholder = null;
        mealCostData.appData.calculationOrder = [...container.querySelectorAll('.order-block')].map(b => b.dataset.key);
        saveData();
    });
}


/**
 * 更新設定值並重新渲染設定區
 * @param {string} key 設定鍵
 * @param {any} value 設定值
 * @returns {void}
 */
function updateSettings(key, value) {
    mealCostData.appData.settings[key] = value;
    saveData();
    renderSettings();
}

/**
 * 新增人員項目
 * @returns {void}
 */
function addPersonnel() {
    mealCostData.appData.personnel.push({
        id: Date.now(),
        name: '',
        mealCost: 0,
        discount: { type: 'amount', value: 0, cap: 0 }
    });
    saveData();
    renderPersonnel();
}

/**
 * 清空人員清單（含確認）
 * @returns {void}
 */
function clearPersonnel() {
    if (confirm('確定要清空「參與者/用餐人士」所有項目嗎？')) {
        mealCostData.appData.personnel = [{
            id: Date.now(),
            name: '',
            mealCost: 0,
            discount: { type: 'amount', value: 0, cap: 0 }
        }];
        saveData();
        renderPersonnel();
    }
}

/**
 * 刪除指定人員（尊重設定中的刪除確認）
 * @param {number} id 人員 ID
 * @returns {void}
 */
function deletePersonnel(id) {
    if (mealCostData.appData.settings.confirmDeleteItem && !confirm('確定要刪除此人員嗎？')) return;
    mealCostData.appData.personnel = mealCostData.appData.personnel.filter(p => p.id !== id);
    saveData();
    renderPersonnel();
}

/**
 * 更新人員欄位
 * @param {number} id 人員 ID
 * @param {string} field 欄位（可含層級，如 'discount.type'）
 * @param {any} value 值
 * @returns {void}
 */
function updatePersonnel(id, field, value) {
    const person = mealCostData.appData.personnel.find(p => p.id === id);
    if (!person) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        person[obj][prop] = value;
    } else {
        person[field] = value;
    }
    saveData();
}

/**
 * 新增均分費用
 * @returns {void}
 */
function addSharedCost() {
    mealCostData.appData.sharedCosts.push({
        id: Date.now(),
        name: '',
        cost: { type: 'amount', value: 0, cap: 0 },
        method: 'evenly'
    });
    saveData();
    renderSharedCosts();
}

/**
 * 清空均分費用（含確認）
 * @returns {void}
 */
function clearSharedCosts() {
    if (confirm('確定要清空「均分費用區」所有項目嗎？')) {
        mealCostData.appData.sharedCosts = [];
        saveData();
        renderSharedCosts();
    }
}

/**
 * 刪除指定均分費用（尊重設定中的刪除確認）
 * @param {number} id 費用 ID
 * @returns {void}
 */
function deleteSharedCost(id) {
    if (mealCostData.appData.settings.confirmDeleteItem && !confirm('確定要刪除此費用嗎？')) return;
    mealCostData.appData.sharedCosts = mealCostData.appData.sharedCosts.filter(sc => sc.id !== id);
    saveData();
    renderSharedCosts();
}

/**
 * 更新均分費用欄位
 * @param {number} id 費用 ID
 * @param {string} field 欄位（可含層級，如 'cost.type'）
 * @param {any} value 值
 * @returns {void}
 */
function updateSharedCost(id, field, value) {
    const cost = mealCostData.appData.sharedCosts.find(sc => sc.id === id);
    if (!cost) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        cost[obj][prop] = value;
    } else {
        cost[field] = value;
    }
    if (field === 'name') addCommonInfo('cost', value);
    saveData();
    if (field === 'cost.type') renderSharedCosts();
}

/**
 * 新增共同優惠
 * @returns {void}
 */
function addSharedDiscount() {
    mealCostData.appData.sharedDiscounts.push({
        id: Date.now(),
        name: '',
        discount: { type: 'amount', value: 0, cap: 0 },
        method: 'evenly'
    });
    saveData();
    renderSharedDiscounts();
}

/**
 * 清空共同優惠（含確認）
 * @returns {void}
 */
function clearSharedDiscounts() {
    if (confirm('確定要清空「共同優惠區」所有項目嗎？')) {
        mealCostData.appData.sharedDiscounts = [];
        saveData();
        renderSharedDiscounts();
    }
}

/**
 * 刪除指定共同優惠（尊重設定中的刪除確認）
 * @param {number} id 優惠 ID
 * @returns {void}
 */
function deleteSharedDiscount(id) {
    if (mealCostData.appData.settings.confirmDeleteItem && !confirm('確定要刪除此優惠嗎？')) return;
    mealCostData.appData.sharedDiscounts = mealCostData.appData.sharedDiscounts.filter(sd => sd.id !== id);
    saveData();
    renderSharedDiscounts();
}

/**
 * 更新共同優惠欄位
 * @param {number} id 優惠 ID
 * @param {string} field 欄位（可含層級，如 'discount.type'）
 * @param {any} value 值
 * @returns {void}
 */
function updateSharedDiscount(id, field, value) {
    const discount = mealCostData.appData.sharedDiscounts.find(sd => sd.id === id);
    if (!discount) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        discount[obj][prop] = value;
    } else {
        discount[field] = value;
    }
    if (field === 'name') addCommonInfo('discount', value);
    saveData();
    if (field === 'discount.type') renderSharedDiscounts();
}

/**
 * 進行整體計算：彙整人員、套用共同優惠與均分費用、顯示結果
 * @returns {void}
 */
function calculate() {
    const stepsLog = [];
    const aggregatedPersonnel = {};

    mealCostData.appData.personnel.forEach(p => {
        const name = p.name.trim() || '未命名';
        if (!aggregatedPersonnel[name]) {
            aggregatedPersonnel[name] = { name, baseMealCost: 0, finalAmount: 0 };
        }
        let cost = p.mealCost;
        let discountAmount = 0;
        if (p.discount.type === 'amount') {
            discountAmount = p.discount.value;
        } else if (p.discount.type === 'percent') {
            discountAmount = cost * (p.discount.value / 100);
            if (p.discount.cap > 0 && discountAmount > p.discount.cap) discountAmount = p.discount.cap;
        }
        stepsLog.push(`人員「${name}」項目：餐費 ${cost}` + (discountAmount > 0 ? ` - 折扣 ${discountAmount} = ${Math.max(cost - discountAmount, 0)}` : ''));
        aggregatedPersonnel[name].baseMealCost += cost;
        aggregatedPersonnel[name].finalAmount += (cost - discountAmount);
    });

    let results = Object.values(aggregatedPersonnel);
    if (results.length === 0) {
        alert('請至少新增一位人員！');
        return;
    }

    const totalBaseMealCost = results.reduce((sum, p) => sum + p.baseMealCost, 0);
    stepsLog.push(`餐費小計(折扣後)：` + results.map(r => `${r.name}:${(r.finalAmount).toFixed(2)}`).join('，'));

    mealCostData.appData.calculationOrder.forEach(step => {
        if (step === 'sharedDiscounts') {
            let currentTotalBeforeDiscount = results.reduce((sum, r) => sum + r.finalAmount, 0);
            stepsLog.push('套用共同優惠：');
            processSharedDiscounts(results, totalBaseMealCost, currentTotalBeforeDiscount, stepsLog);
        } else if (step === 'sharedCosts') {
            stepsLog.push('加入均分費用：');
            processSharedCosts(results, totalBaseMealCost, stepsLog);
        }
    });

    displayResults(results, stepsLog);
}

/**
 * 套用共同優惠（支持金額/比例，上限與平均/比例分攤）
 * @param {Array} results 人員結果陣列（含 baseMealCost、finalAmount）
 * @param {number} totalBaseMealCost 餐費基礎總額（未含共同內容）
 * @param {number} currentTotal 目前折扣前總額（用於比例折扣）
 * @param {string[]} stepsLog 步驟紀錄
 * @returns {void}
 */
function processSharedDiscounts(results, totalBaseMealCost, currentTotal, stepsLog) {
    mealCostData.appData.sharedDiscounts.forEach(sd => {
        let totalDiscountValue = 0;
        if (sd.discount.type === 'amount') {
            totalDiscountValue = sd.discount.value;
        } else {
            totalDiscountValue = currentTotal * (sd.discount.value / 100);
            if (sd.discount.cap > 0 && totalDiscountValue > sd.discount.cap) totalDiscountValue = sd.discount.cap;
        }
        stepsLog.push(`- ${sd.name || '未命名優惠'}... 合計折扣 ${totalDiscountValue.toFixed(2)}`);

        if (sd.method === 'evenly') {
            if (results.length > 0) {
                const discountPerPerson = totalDiscountValue / results.length;
                results.forEach(r => r.finalAmount -= discountPerPerson);
                stepsLog.push(`  平均攤分，每人 -${discountPerPerson.toFixed(2)}`);
            }
        } else {
            if (totalBaseMealCost > 0) {
                results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
                    const d = totalDiscountValue * proportion;
                    r.finalAmount -= d;
                    stepsLog.push(`  ${r.name} 按比例 -${d.toFixed(2)}`);
                });
            }
        }
        currentTotal = results.reduce((sum, r) => sum + r.finalAmount, 0);
    });
}

/**
 * 套用均分費用（支持金額/比例，上限與平均/比例分攤）
 * @param {Array} results 人員結果陣列（含 baseMealCost、finalAmount）
 * @param {number} totalBaseMealCost 餐費基礎總額（用於比例計算）
 * @param {string[]} stepsLog 步驟紀錄
 * @returns {void}
 */
function processSharedCosts(results, totalBaseMealCost, stepsLog) {
    mealCostData.appData.sharedCosts.forEach(sc => {
        let totalCostValue = 0;
        if (sc.cost.type === 'amount') {
            totalCostValue = sc.cost.value;
        } else {
            totalCostValue = totalBaseMealCost * (sc.cost.value / 100);
            if (sc.cost.cap > 0 && totalCostValue > sc.cost.cap) totalCostValue = sc.cost.cap;
        }
        stepsLog.push(`- ${sc.name || '未命名費用'}... 合計費用 ${totalCostValue.toFixed(2)}`);

        if (sc.method === 'evenly') {
            if (results.length > 0) {
                const costPerPerson = totalCostValue / results.length;
                results.forEach(r => r.finalAmount += costPerPerson);
                stepsLog.push(`  平均攤分，每人 +${costPerPerson.toFixed(2)}`);
            }
        } else {
            if (totalBaseMealCost > 0) {
                results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
                    const c = totalCostValue * proportion;
                    r.finalAmount += c;
                    stepsLog.push(`  ${r.name} 按比例 +${c.toFixed(2)}`);
                });
            }
        }
    });
}

/**
 * 以設定的進位方式與小數位數顯示結果，並可選擇顯示計算步驟
 * @param {Array} results 計算後的人員清單（含 finalAmount）
 * @param {string[]} [stepsLog=[]] 步驟紀錄
 * @returns {void}
 */
function displayResults(results, stepsLog = []) {
    const detailsDiv = document.getElementById('result-details');
    const grandTotalP = document.getElementById('grand-total');
    const stepsUl = document.getElementById('calc-steps');
    const { decimalPlaces, roundingMethod } = mealCostData.appData.settings;
    const multiplier = 10 ** decimalPlaces;

    function roundValue(val) {
        if (roundingMethod === 'ceil') return Math.ceil(val * multiplier) / multiplier;
        if (roundingMethod === 'floor') return Math.floor(val * multiplier) / multiplier;
        return Math.round(val * multiplier) / multiplier;
    }

    stepsUl.innerHTML = '';
    if (mealCostData.appData.settings.showSteps && stepsLog.length) {
        stepsLog.forEach(t => {
            const li = document.createElement('li');
            li.textContent = t;
            stepsUl.appendChild(li);
        });
    }

    detailsDiv.innerHTML = '';
    let grandTotal = 0;
    results.forEach(r => {
        const finalAmountRounded = roundValue(Math.max(0, r.finalAmount));
        grandTotal += finalAmountRounded;
        const p = document.createElement('p');
        p.textContent = `${r.name} 應付: $ ${finalAmountRounded.toFixed(decimalPlaces)}`;
        detailsDiv.appendChild(p);
    });
    grandTotalP.textContent = `收款總計: $ ${grandTotal.toFixed(decimalPlaces)}`;
}

/**
 * 新增常用詞至對應清單（若不存在）
 * @param {'person'|'cost'|'discount'} type 類型
 * @param {string} name 文字
 * @returns {void}
 */
function addCommonInfo(type, name) {
    name = (name || '').trim();
    if (!name) return;
    if (!mealCostData.commonInfo[type].includes(name)) {
        mealCostData.commonInfo[type].push(name);
        saveData();
    }
}

/**
 * 刪除常用清單項目（尊重設定中的刪除確認）
 * @param {'person'|'cost'|'discount'} type 類型
 * @param {number} idx 索引
 * @param {Function} [callback] 刪除後回呼（用於刷新 UI）
 * @returns {void}
 */
function deleteCommonInfoItem(type, idx, callback) {
    if (mealCostData.appData.settings.confirmDeleteOption) {
        if (!confirm(`確定要刪除常用項目「${mealCostData.commonInfo[type][idx]}」嗎？`)) return;
    }
    mealCostData.commonInfo[type].splice(idx, 1);
    saveData();
    if (callback) callback();
}

/**
 * 從現有 appData 同步常用詞（避免遺漏手動輸入過的名稱）
 * @returns {void}
 */
function syncCommonInfoFromAppData() {
    mealCostData.appData.personnel.forEach(p => addCommonInfo('person', p.name));
    mealCostData.appData.sharedCosts.forEach(sc => addCommonInfo('cost', sc.name));
    mealCostData.appData.sharedDiscounts.forEach(sd => addCommonInfo('discount', sd.name));
}


/**
 * 初始化：綁定事件、設定拖曳、同步常用詞並渲染
 * @returns {void}
 */
document.addEventListener('DOMContentLoaded', () => {
    // Emoji 支援檢測（不支援時以文字替代圖示）
    function supportsEmoji(char) {
        const span = document.createElement('span');
        span.textContent = char;
        return span.textContent === char && span.innerText === char;
    }
    if (!supportsEmoji('🗑️')) {
        document.querySelectorAll('.delete-icon').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.delete-fallback').forEach(e => e.style.display = 'inline');
    }
    if (!supportsEmoji('🧹')) {
        document.querySelectorAll('.clear-icon').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.clear-fallback').forEach(e => e.style.display = 'inline');
    }

    // Modal 事件綁定
    const modal = document.getElementById('common-info-modal');
    document.getElementById('settings-btn').onclick = () => { modal.style.display = 'flex'; };
    document.querySelector('#common-info-modal .close-modal').onclick = () => modal.style.display = 'none';
    window.onclick = (event) => { if (event.target === modal) modal.style.display = 'none'; };
    
    // 同步常用詞
    syncCommonInfoFromAppData();

    // 設定拖曳功能
    setupDrag('#personnel-list', mealCostData.appData.personnel);
    setupDrag('#shared-costs-list', mealCostData.appData.sharedCosts);
    setupDrag('#shared-discounts-list', mealCostData.appData.sharedDiscounts);
    setupOrderDragAndDrop();

    // 首次渲染
    render();
});
</script>

</body>
</html>
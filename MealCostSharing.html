<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤è²»è¨ˆç®—æ©Ÿ</title>
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#f4f7f6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <style>
        :root { color-scheme: light dark; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            max-width: 1080px;
            margin: 0 auto;
        }
        .container {
            position: relative;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        /* ã€æ–°å¢ã€‘è®“æ‹–æ›³ä¸­çš„é …ç›®æœ‰æ›´æ˜é¡¯çš„æ¨£å¼ */
        .item-row.dragging {
            opacity: 0.5;
            background: #cce5ff;
        }
        .item-row input, .item-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .item-row input[type="text"] { flex-grow: 1; min-width: 100px; }
        .item-row input[type="number"] { width: 100px; }
        .discount-logic, .cost-logic { /* Added .cost-logic */
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background-color: transparent;
            color: #d32f2f;
            border: none;
            padding: 8px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover { background-color: #ffeaea; }
        .delete-icon {
            font-size: 18px;
            line-height: 1;
        }
        .delete-fallback {
            font-size: 14px;
            color: white;
            background-color: #f44336;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .add-btn, .calc-btn, .temp-save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        /* æ¨™é¡Œæ—æ¸…ç©ºæŒ‰éˆ•ï¼ˆåœ–ç¤ºç‚ºä¸»ï¼Œç¼ºæ”¯æ´æ™‚ç”¨æ–‡å­—ï¼‰ */
        .clear-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 6px;
            vertical-align: middle;
        }
        .clear-btn:hover { background: #f0f0f0; }
        .calc-btn {
            width: 100%;
        }
        .add-btn:hover, .calc-btn:hover, .temp-save-btn:hover { background-color: #45a049; }
        .temp-save-btn {
            background-color: #008CBA;
            margin-left: 10px;
        }
        .temp-save-btn:hover { background-color: #007ba7; }
        
        #calculation-order-container {
            display: flex;
            gap: 15px;
            padding: 10px;
            border: 1px dashed #aaa;
            border-radius: 5px;
            /* RWD: ç¶­æŒå–®è¡Œä¸¦å¯æ©«å‘æ»¾å‹•ï¼Œé¿å…å¤šè¡Œå°è‡´åˆ¤æ–·æ··äº‚ */
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .order-block {
            padding: 15px 25px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            user-select: none;
            border: 2px solid #ccc;
            /* RWD: åœ¨å¯æ»¾å‹•å®¹å™¨å…§å›ºå®šè‡ªèº«å¯¬åº¦æ¯”ä¾‹ */
            flex: 0 0 auto;
        }
        .order-block.dragging { opacity: 0.5; background: #b0b0b0; }
        
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4CAF50;
            border-radius: 5px;
        }
        #results h3 { margin-top: 0; }
        #results p { margin: 5px 0; font-size: 1.1em; }
        #results #grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #d32f2f;
            margin-top: 15px;
        }
        .save-feedback {
            color: #4CAF50;
            font-style: italic;
            margin-left: 15px;
            display: none;
        }
        .settings-area { margin-bottom: 15px; }
    .settings-area label { font-weight: bold; }
    .settings-area input { width: 60px; }

    /* Switch styles (åƒè€ƒç”¨) */
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
    .switch input:checked + .slider { background-color: #2196F3; }
    .switch input:checked + .slider:before { transform: translateX(26px); }

    /* æ­¥é©Ÿåˆ—è¡¨æ¨£å¼ */
    .steps { margin: 6px 0 10px 0; padding-left: 16px; color: #2f4f4f; }
    .steps li { margin: 2px 0; }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 30px 30px 20px 30px;
            border-radius: 10px;
            min-width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 28px;
            cursor: pointer;
        }
        .common-list-block { margin-bottom: 18px; }
        .common-list { list-style: none; padding: 0; margin: 0; }
        .common-list li {
            background: #f7f7f7;
            margin-bottom: 6px;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            justify-content: space-between;
        }
        .common-list li.dragging { opacity: 0.5; background: #e0e0e0; }
        .common-list .delete-btn {
            background: none;
            color: #d32f2f;
            font-size: 18px;
            border: none;
            cursor: pointer;
            padding: 0 6px;
        }
        
        #settings-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 28px;
            cursor: pointer;
            z-index: 20;
        }

        /* --- è‡ªè¨‚è‡ªå‹•å®Œæˆå»ºè­°é¸å–®æ¨£å¼ --- */
        .autocomplete-container {
            position: relative;
            width: 100%;
            display: inline;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px; /* ã€èª¿æ•´1ã€‘æ–°å¢èˆ‡è¼¸å…¥æ¡†çš„é–“è· */
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none; /* é˜²æ­¢æ‹–æ›³æ™‚é¸å–æ–‡å­— */
        }
        .suggestion-item:hover, .suggestion-item.active {
            background-color: #f0f0f0;
        }
        .suggestion-item.dragging {
            opacity: 0.5;
            background-color: #d0d0d0;
        }
        .suggestion-delete-btn {
            background: transparent;
            border: none;
            color: #d32f2f;
            font-size: 18px;
            cursor: pointer;
            padding: 3px 3px;
            margin-left: 8px;
            border-radius: 4px;
            outline: 1.5px solid transparent;
            transition: outline-color 0.2s;
        }
        .suggestion-delete-btn:hover {
            outline-color: #A292B5; /* åœ¨æš—æ¨¡å¼ä¸‹ä½¿ç”¨æ›´äº®çš„ç´…è‰²ï¼Œèˆ‡åœ–ç¤ºé¡è‰²ä¸€è‡´ */
            transform: scale(1.1); /* ç¨å¾®æ”¾å¤§åœ–ç¤ºï¼Œæä¾›å‹•æ…‹å›é¥‹ */
        }

        /* --- ã€æ–°å¢ã€‘æ‹–æ›³æ™‚çš„é è¦½å€å¡Šæ¨£å¼ --- */
        .placeholder {
            background: #f0f0f0;
            border: 2px dashed #aaa;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .item-row.placeholder {
            margin-bottom: 10px;
        }

        /* æš—é»‘æ¨¡å¼è¦†å¯« */
        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e6e6e6; }
            .container { background: #1b1c1f; box-shadow: 0 6px 20px rgba(0,0,0,0.7); }
            h1, h2 { color: #f0f0f0; border-bottom-color: #5aa95e; }

            /* å€å¡Šæ›´åˆ†æ˜ï¼šåŠ å¼·é‚Šæ¡†èˆ‡é™°å½±ï¼Œç•¥å¾®æå‡èƒŒæ™¯äº®åº¦å·® */
            .section { color: inherit; }
            .item-row { background-color: #22252a; border: 1px solid #3a3f45; box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset, 0 1px 6px rgba(0,0,0,0.35); }
            /* ã€æ–°å¢ã€‘æš—é»‘æ¨¡å¼æ‹–æ›³æ¨£å¼ */
            .item-row.dragging {
                opacity: 0.5;
                background: #3a3f45;
            }
            .item-row input, .item-row select { background-color: #2a2e35; color: #e6e6e6; border-color: #4b515a; }
            .item-row input::placeholder { color: #9aa0a6; }
            .item-row:focus-within { outline: 2px solid rgba(97, 218, 251, 0.3); outline-offset: 1px; }

            .delete-btn { color: #ff6b6b; }
            .delete-btn:hover { background-color: rgba(255, 77, 77, 0.12); }

            #calculation-order-container { border-color: #555; background: #191b1d; }
            .order-block { background-color: #2a2e35; border: 2px solid #464c55; color: #e6e6e6; box-shadow: 0 1px 8px rgba(0,0,0,0.35); }
            .order-block.dragging { opacity: 0.8; background: #343a42; }

            #results { background-color: #162217; border-left: 5px solid #5aa95e; box-shadow: 0 1px 8px rgba(0,0,0,0.35) inset; }
            #results h3 { color: #e6e6e6; }
            #results p { color: #e6e6e6; }
            #results #grand-total { color: #ff9a8f; }

            .steps { color: #c0d0d0; }

            .modal { background: rgba(0,0,0,0.55); }
            .modal-content { background: #1e2024; color: #e6e6e6; box-shadow: 0 10px 32px rgba(0,0,0,0.75); }
            .close-modal { color: #e6e6e6; }

            .common-list li { background: #23272d; border: 1px solid #3a3f45; }
            .common-list li.dragging { background: #2f343b; }
            .common-list .delete-btn { color: #ff6b6b; }

            .switch .slider { background-color: #555; }
            .switch input:checked + .slider { background-color: #1b82d1; }

            /* æš—é»‘æ¨¡å¼çš„æŒ‰éˆ•å»äº®åŒ–èˆ‡é™ä½é£½å’Œåº¦ï¼Œå¢åŠ  hover å°æ¯”ä½†ä¸åˆºçœ¼ */
            .add-btn, .calc-btn { background-color: #3c8f43; color: #fff; }
            .add-btn:hover, .calc-btn:hover { background-color: #377f3d; }
            .temp-save-btn { background-color: #1b82d1; }
            .temp-save-btn:hover { background-color: #176faf; }

            #settings-btn { color: #e6e6e6; }

            /* æš—è‰²æ¨¡å¼ä¸‹çš„æ¸…ç©ºæŒ‰éˆ• */
            .clear-btn { color: #c9c9c9; border-color: #555; }
            .clear-btn:hover { background: #2a2e35; }
            
            /* æš—é»‘æ¨¡å¼ä¸‹çš„è‡ªè¨‚é¸å–® */
            .autocomplete-suggestions {
                background-color: #2a2e35;
                border-color: #4b515a;
                box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            }
            .suggestion-item:hover, .suggestion-item.active {
                background-color: #343a42;
            }
            .suggestion-item.dragging {
                background-color: #4b515a;
            }
            .suggestion-delete-btn {
                color: #ff6b6b;
            }
            .suggestion-delete-btn:hover {
                background-color: rgba(255, 107, 107, 0.25); /* å¢åŠ èƒŒæ™¯è‰²çš„ä¸é€æ˜åº¦å’Œäº®åº¦ */
                transform: scale(1.1); /* åŒæ¨£åŠ ä¸Šæ”¾å¤§æ•ˆæœ */
            }
            /* --- ã€æ–°å¢ã€‘æš—é»‘æ¨¡å¼ä¸‹çš„é è¦½å€å¡Š --- */
            .placeholder {
                background: #2a2e35;
                border-color: #555;
            }
        }

        /* æ‰‹æ©Ÿ/å°å¹³æ¿å„ªåŒ– */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .container { padding: 16px; }
            h1 { font-size: 1.4rem; }
            h2 { font-size: 1.1rem; }

            /* è¡¨å–®åˆ—æ”¹ç‚ºç›´å‘å †ç–Š */
            .item-row { flex-direction: column; align-items: stretch; gap: 8px; }
            .item-row label { width: 100%; }
            .item-row input, .item-row select { width: 100%; box-sizing: border-box; }
            .discount-logic, .cost-logic { flex-wrap: wrap; }
            .item-row input[type="number"] { width: 100%; }

            /* æŒ‰éˆ•å…¨å¯¬ï¼Œè§¸æ§æ›´å¥½é»æ“Š */
            .add-btn, .calc-btn, .temp-save-btn { width: 100%; margin: 6px 0 0 0; }
            .delete-btn { align-self: flex-end; padding: 10px 8px; }
            /* åƒ…é™ä¸‰å€‹è¼¸å…¥å€çš„åˆªé™¤éµåœ¨æ‰‹æ©Ÿæ’æ»¿æ•´è¡Œï¼Œæå‡å¯é»æ“Šæ€§ */
            .item-row .delete-btn { width: 100%; align-self: stretch; justify-content: center; }

            /* è¨­å®šå€æ”¹å–®æ¬„æ’åˆ— */
            .settings-area { display: grid; grid-template-columns: 1fr; row-gap: 8px; }
            .settings-area input { width: 100%; }

            /* è¨ˆç®—é †åºå€ç¸®å°å€å¡Šä¸¦å…è¨±å·¦å³æ»‘å‹• */
            #calculation-order-container { gap: 10px; }
            .order-block { padding: 10px 14px; font-size: 14px; }

            /* çµæœå€å­—ç´šé©åº¦ç¸®å° */
            #results p { font-size: 1rem; }

            /* Modal åœ¨æ‰‹æ©Ÿä¸Šè‡ªé©æ‡‰ */
            .modal-content { min-width: auto; width: 92vw; padding: 20px 16px; }

            /* è¨­å®šæŒ‰éˆ•åœ¨å°è¢å¹•å¾®èª¿ä½ç½®èˆ‡å°ºå¯¸ */
            #settings-btn { top: 12px; right: 12px; font-size: 24px; }

            /* é¿å…ç€æµ·/å®‰å…¨å€é®ä½å…§å®¹ï¼ˆiOSï¼‰ */
            body { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        }

        /* ã€èª¿æ•´2ã€‘é‡å°æ¡Œæ©Ÿç‰ˆçš„é¸å–®å¾®èª¿ */
        @media (min-width: 769px) {
            .suggestion-delete-btn {
                font-size: 10px; /* ç¨å¾®ç¸®å°åˆªé™¤åœ–ç¤º */
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>é¤è²»è¨ˆç®—æ©Ÿ</h1>

    <div class="section">
        <h2>1. åƒèˆ‡è€…/ç”¨é¤äººå£« (åŒåäººå“¡é …ç›®æœƒè‡ªå‹•åˆä½µè¨ˆç®—)
            <button class="clear-btn" title="æ¸…ç©ºæ­¤å€" onclick="clearPersonnel()">
                <span class="clear-icon" aria-label="æ¸…ç©º" role="img">ğŸ§¹</span>
                <span class="clear-fallback" style="display:none;">æ¸…ç©º</span>
            </button>
        </h2>
        <div id="personnel-list"></div>
    <button class="add-btn" onclick="addPersonnel()">æ–°å¢é …ç›®</button>
    </div>

    <div class="section">
        <h2>2. å‡åˆ†è²»ç”¨å€
            <button class="clear-btn" title="æ¸…ç©ºæ­¤å€" onclick="clearSharedCosts()">
                <span class="clear-icon" aria-label="æ¸…ç©º" role="img">ğŸ§¹</span>
                <span class="clear-fallback" style="display:none;">æ¸…ç©º</span>
            </button>
        </h2>
        <div id="shared-costs-list"></div>
    <button class="add-btn" onclick="addSharedCost()">æ–°å¢å‡åˆ†è²»ç”¨</button>
    </div>

    <div class="section">
        <h2>3. å…±åŒå„ªæƒ å€
            <button class="clear-btn" title="æ¸…ç©ºæ­¤å€" onclick="clearSharedDiscounts()">
                <span class="clear-icon" aria-label="æ¸…ç©º" role="img">ğŸ§¹</span>
                <span class="clear-fallback" style="display:none;">æ¸…ç©º</span>
            </button>
        </h2>
        <div id="shared-discounts-list"></div>
    <button class="add-btn" onclick="addSharedDiscount()">æ–°å¢å…±åŒå„ªæƒ </button>
    </div>
    
    <div class="section">
        <h2>4. è¨ˆç®—æ–¹å¼ (å¯æ‹–æ›³èª¿æ•´é †åº)</h2>
        <div id="calculation-order-container"></div>
    </div>

    <div class="section">
        <h2>5. é€²è¡Œè¨ˆç®—</h2>
        <div class="settings-area">
            <label>é€²ä½æ–¹å¼:
                <select id="rounding-method" onchange="updateSettings('roundingMethod', this.value)">
                    <option value="round">å››æ¨äº”å…¥</option>
                    <option value="ceil">ä¸Šæ¨å…¥</option>
                    <option value="floor">ä¸‹æ¨å…¥</option>
                </select>
            </label>
            <label style="margin-left: 18px;">å°æ•¸ä½æ•¸: 
                <input type="number" id="decimal-places" min="0" max="10" 
                       oninput="updateSettings('decimalPlaces', parseInt(this.value))">
            </label>
            <span style="margin-left: 18px;">
                <span style="font-weight:bold; vertical-align: middle;">é¡¯ç¤ºè¨ˆç®—éç¨‹</span>
                <label class="switch" style="margin-left:8px;">
                    <input type="checkbox" id="show-steps-toggle" onchange="updateSettings('showSteps', this.checked)">
                    <span class="slider"></span>
                </label>
            </span>
        </div>
        <button class="calc-btn" onclick="calculate()">è¨ˆç®—</button>
        <div id="results">
            <h3>è¨ˆç®—çµæœ</h3>
            <ul id="calc-steps" class="steps" style="display:none;"></ul>
            <div id="result-details">-- ç­‰å¾…è¨ˆç®— --</div>
            <p id="grand-total"></p>
        </div>
    </div>

    <div id="settings-btn" title="åå¥½è¨­å®š">âš™ï¸</div>
    <div id="common-info-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-modal" title="é—œé–‰">&times;</span>
        <h2>åå¥½è¨­å®š</h2>
                <div class="common-list-block">
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
                        <span style="font-weight:bold;">åˆªé™¤ã€Œé …ç›®ã€æ™‚ç¢ºèª</span>
                        <label class="switch">
                            <input type="checkbox" id="confirm-delete-item-toggle" onchange="updateSettings('confirmDeleteItem', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <small>åˆªé™¤ã€Œäººå“¡ã€å‡åˆ†è²»ç”¨ã€å…±åŒå„ªæƒ ã€é …ç›®æ™‚ï¼Œè·³å‡ºç¢ºèªæç¤ºã€‚</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <span style="font-weight:bold;">åˆªé™¤ã€Œå¸¸ç”¨é¸é …ã€æ™‚ç¢ºèª</span>
                        <label class="switch">
                            <input type="checkbox" id="confirm-delete-option-toggle" onchange="updateSettings('confirmDeleteOption', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <small>å¾è¼¸å…¥å»ºè­°é¸å–®ä¸­åˆªé™¤å¸¸ç”¨åç¨±æ™‚ï¼Œè·³å‡ºç¢ºèªæç¤ºã€‚</small>
                    </div>
                </div>
      </div>
    </div>
</div>

<script>
// ===== SCRIPT START =====
// ã€ä¿®æ”¹ã€‘çµ±ä¸€çš„å„²å­˜éµï¼Œç§»é™¤ç‰ˆæœ¬è™Ÿ
const UNIFIED_STORAGE_KEY = 'MealCostSharingData';
// ã€æ–°å¢ã€‘èˆŠçš„å„²å­˜éµï¼Œç”¨æ–¼è³‡æ–™é·ç§»
const OLD_STORAGE_KEY = 'splitBillCalculatorData_v2';
const OLD_COMMON_KEY = 'splitBillCommonInfo_v1';

// ã€ä¿®æ”¹ã€‘çµ±ä¸€çš„é è¨­è³‡æ–™çµæ§‹
const defaultMealCostData = {
    appData: {
        personnel: [{ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }],
        sharedCosts: [],
        sharedDiscounts: [],
        calculationOrder: ['personnel', 'sharedDiscounts', 'sharedCosts'],
        settings: {
            decimalPlaces: 1,
            roundingMethod: 'round',
            showSteps: false,
            confirmDeleteItem: true,
            confirmDeleteOption: true
        }
    },
    commonInfo: {
        person: [],
        cost: [],
        discount: []
    }
};

// ã€ä¿®æ”¹ã€‘å°‡æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼è³‡æ–™å„²å­˜åœ¨ä¸€å€‹ç‰©ä»¶ä¸­
let mealCostData = loadInitialData();


// ===== Custom Autocomplete Class (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
class CustomAutocomplete {
    constructor(inputElement, type) {
        this.input = inputElement;
        this.type = type;
        this.container = this.input.parentElement;
        this.suggestionsContainer = null;
        this.activeSuggestionIndex = -1;
        this.draggedItem = null;
        this.dragStartIndex = -1;
        this.isDragging = false;
        this.clickTimeout = null;
        this.placeholder = null; 
        this.init();
    }

    init() {
        this.input.addEventListener('focus', () => this.showSuggestions());
        this.input.addEventListener('input', () => this.showSuggestions());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.hideSuggestions();
            }
        });
    }

    showSuggestions() {
        const value = this.input.value.toLowerCase();
        const suggestions = mealCostData.commonInfo[this.type].filter(item => item.toLowerCase().includes(value));

        if (!this.suggestionsContainer) {
            this.suggestionsContainer = document.createElement('div');
            this.suggestionsContainer.className = 'autocomplete-suggestions';
            this.container.appendChild(this.suggestionsContainer);
        }

        this.suggestionsContainer.innerHTML = '';
        this.activeSuggestionIndex = -1;

        if (suggestions.length === 0) {
            this.hideSuggestions();
            return;
        }
        
        this.suggestionsContainer.style.display = 'block';

        suggestions.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'suggestion-item';
            itemDiv.dataset.value = item;
            
            const textSpan = document.createElement('span');
            textSpan.textContent = item;
            itemDiv.appendChild(textSpan);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'suggestion-delete-btn';
            deleteBtn.innerHTML = 'âœ–ï¸';
            deleteBtn.title = 'åˆªé™¤æ­¤å¸¸ç”¨é …ç›®';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const originalIndex = mealCostData.commonInfo[this.type].indexOf(item);
                if (originalIndex > -1) {
                    deleteCommonInfoItem(this.type, originalIndex, () => {
                        this.showSuggestions();
                    });
                }
            });
            itemDiv.appendChild(deleteBtn);

            itemDiv.addEventListener('mousedown', (e) => {
                if (e.target === deleteBtn) return;
                e.preventDefault();

                this.isDragging = false;
                this.draggedItem = itemDiv;
                this.dragStartIndex = mealCostData.commonInfo[this.type].indexOf(item);

                this.clickTimeout = setTimeout(() => {
                    this.isDragging = true;
                    this.draggedItem.classList.add('dragging');
                    this.suggestionsContainer.style.cursor = 'grabbing';
                    
                    this.placeholder = document.createElement('div');
                    this.placeholder.className = 'suggestion-item placeholder';
                    const rect = this.draggedItem.getBoundingClientRect();
                    this.placeholder.style.height = `${rect.height}px`;
                    
                }, 200);

                const onMouseMove = (moveE) => {
                    if (this.isDragging) {
                        this.handleDrag(moveE);
                    }
                };

                const onMouseUp = () => {
                    clearTimeout(this.clickTimeout);
                    if (!this.isDragging) {
                        this.selectSuggestion(item);
                    } else {
                        this.draggedItem.classList.remove('dragging');
                        this.suggestionsContainer.style.cursor = '';
                        
                        if (this.placeholder && this.placeholder.parentNode) {
                            this.placeholder.parentNode.replaceChild(this.draggedItem, this.placeholder);
                        }
                        
                        this.updateCommonInfoOrder();
                    }
                    this.draggedItem = null;
                    if (this.placeholder) {
                        if (this.placeholder.parentNode) this.placeholder.remove();
                        this.placeholder = null;
                    }
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            this.suggestionsContainer.appendChild(itemDiv);
        });
    }

    handleDrag(e) {
        if (!this.draggedItem || !this.placeholder) return;
        const afterElement = this.getDragAfterElement(this.suggestionsContainer, e.clientY);
        
        if (afterElement == null) {
            this.suggestionsContainer.appendChild(this.placeholder);
        } else {
            this.suggestionsContainer.insertBefore(this.placeholder, afterElement);
        }
    }
    
    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.suggestion-item:not(.dragging):not(.placeholder)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    updateCommonInfoOrder() {
        const newOrder = [...this.suggestionsContainer.querySelectorAll('.suggestion-item:not(.placeholder)')].map(item => item.dataset.value);
        const originalArray = mealCostData.commonInfo[this.type];
        const newArray = newOrder.concat(originalArray.filter(item => !newOrder.includes(item)));
        mealCostData.commonInfo[this.type] = newArray;
        saveData();
    }
    
    selectSuggestion(value) {
        this.input.value = value;
        this.hideSuggestions();
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
    }

    hideSuggestions() {
        if (this.suggestionsContainer) {
            this.suggestionsContainer.style.display = 'none';
        }
    }

    handleKeydown(e) {
        if (!this.suggestionsContainer || this.suggestionsContainer.style.display === 'none') return;
        const items = this.suggestionsContainer.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault(); this.activeSuggestionIndex = (this.activeSuggestionIndex + 1) % items.length; this.updateActiveSuggestion(items); break;
            case 'ArrowUp':
                e.preventDefault(); this.activeSuggestionIndex = (this.activeSuggestionIndex - 1 + items.length) % items.length; this.updateActiveSuggestion(items); break;
            case 'Enter':
                e.preventDefault(); if (this.activeSuggestionIndex > -1) { this.selectSuggestion(items[this.activeSuggestionIndex].dataset.value); } break;
            case 'Escape':
                this.hideSuggestions(); break;
        }
    }
    
    updateActiveSuggestion(items) {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === this.activeSuggestionIndex);
        });
        items[this.activeSuggestionIndex].scrollIntoView({ block: 'nearest' });
    }
}


// ===== è³‡æ–™è™•ç† (å­˜/è®€) (å·²é‡æ§‹) =====
function saveData() { 
    try { 
        localStorage.setItem(UNIFIED_STORAGE_KEY, JSON.stringify(mealCostData)); 
    } catch (e) { 
        console.error("Error saving unified data:", e); 
    } 
}

function loadInitialData() {
    // 1. å˜—è©¦å¾æ–°çš„çµ±ä¸€éµè¼‰å…¥
    const unifiedDataStr = localStorage.getItem(UNIFIED_STORAGE_KEY);
    if (unifiedDataStr) {
        try {
            const loadedData = JSON.parse(unifiedDataStr);
            // èˆ‡é è¨­å€¼åˆä½µï¼Œç¢ºä¿æ‰€æœ‰å±¬æ€§éƒ½å­˜åœ¨ï¼Œé¿å…æœªä¾†æ–°å¢å±¬æ€§æ™‚å‡ºéŒ¯
            const defaultAppData = defaultMealCostData.appData;
            const defaultCommonInfo = defaultMealCostData.commonInfo;
            const finalAppData = { ...defaultAppData, ...(loadedData.appData || {}), settings: { ...defaultAppData.settings, ...(loadedData.appData ? loadedData.appData.settings : {}) } };
            const finalCommonInfo = { ...defaultCommonInfo, ...(loadedData.commonInfo || {}) };
            return { appData: finalAppData, commonInfo: finalCommonInfo };
        } catch (e) {
            console.error("Error parsing unified data, falling back to defaults.", e);
            return JSON.parse(JSON.stringify(defaultMealCostData));
        }
    }

    // 2. è‹¥æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾èˆŠçš„éµé·ç§»è³‡æ–™
    const oldAppDataStr = localStorage.getItem(OLD_STORAGE_KEY);
    const oldCommonInfoStr = localStorage.getItem(OLD_COMMON_KEY);

    if (oldAppDataStr) {
        console.log("Migrating data from old version...");
        let migratedData = JSON.parse(JSON.stringify(defaultMealCostData)); // å¾ä¸€å€‹ä¹¾æ·¨çš„é è¨­çµæ§‹é–‹å§‹

        // é·ç§» appData
        try {
            const savedAppData = JSON.parse(oldAppDataStr);
            // å‘å¾Œç›¸å®¹æ€§ï¼šè™•ç†èˆŠçš„ sharedCosts çµæ§‹
            if (savedAppData.sharedCosts && savedAppData.sharedCosts.length > 0) {
                savedAppData.sharedCosts.forEach(sc => {
                    if (typeof sc.amount !== 'undefined' && typeof sc.cost === 'undefined') {
                        sc.cost = { type: 'amount', value: sc.amount, cap: 0 };
                        delete sc.amount;
                    }
                });
            }
            // å‘å¾Œç›¸å®¹æ€§ï¼šè™•ç†èˆŠçš„ settings çµæ§‹
            if (savedAppData.settings && typeof savedAppData.settings.confirmDelete !== 'undefined') {
                savedAppData.settings.confirmDeleteItem = savedAppData.settings.confirmDelete;
                savedAppData.settings.confirmDeleteOption = savedAppData.settings.confirmDelete;
                delete savedAppData.settings.confirmDelete;
            }
            migratedData.appData = { ...migratedData.appData, ...savedAppData, settings: { ...migratedData.appData.settings, ...(savedAppData.settings || {}) } };
        } catch (e) {
            console.error("Error parsing old appData during migration:", e);
        }

        // é·ç§» commonInfo
        if (oldCommonInfoStr) {
            try {
                const savedCommonInfo = JSON.parse(oldCommonInfoStr);
                migratedData.commonInfo = { person: savedCommonInfo.person || [], cost: savedCommonInfo.cost || [], discount: savedCommonInfo.discount || [] };
            } catch (e) {
                console.error("Error parsing old commonInfo during migration:", e);
            }
        }
        
        // å°‡æ–°é·ç§»çš„è³‡æ–™å­˜å…¥çµ±ä¸€éµï¼Œä¸¦ç§»é™¤èˆŠçš„éµ
        try {
            localStorage.setItem(UNIFIED_STORAGE_KEY, JSON.stringify(migratedData));
            localStorage.removeItem(OLD_STORAGE_KEY);
            localStorage.removeItem(OLD_COMMON_KEY);
        } catch (e) {
            console.error("Could not save migrated data or remove old keys.", e);
        }

        return migratedData;
    }

    // 3. å¦‚æœä»€éº¼éƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å›å…¨æ–°çš„é è¨­çµæ§‹
    return JSON.parse(JSON.stringify(defaultMealCostData));
}

// ===== æ¸²æŸ“ç•«é¢ (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
function render() {
    renderPersonnel();
    renderSharedCosts();
    renderSharedDiscounts();
    renderCalculationOrder();
    renderSettings();
}

function renderPersonnel() {
    const list = document.getElementById('personnel-list');
    list.innerHTML = '';
    mealCostData.appData.personnel.forEach(p => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-personnel';
        div.dataset.id = p.id;
        div.draggable = true;
        div.innerHTML = `
            <label>å§“å: <div class="autocomplete-container"><input type="text" value="${p.name}" class="person-name-input" data-id="${p.id}"></div></label>
            <label>é¤è²»: <input type="number" min="0" value="${p.mealCost}" class="person-mealcost-input" data-id="${p.id}"></label>
            <div class="discount-logic">
                <label>æŠ˜æ‰£:</label>
                <select class="person-discount-type" data-id="${p.id}"><option value="amount" ${p.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option><option value="percent" ${p.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option></select>
                <input type="number" min="0" value="${p.discount.value}" class="person-discount-value" data-id="${p.id}">
                ${p.discount.type === 'percent' ? `<label>ä¸Šé™: <input type="number" min="0" value="${p.discount.cap}" class="person-discount-cap" data-id="${p.id}"></label><small>(0ç‚ºç„¡ä¸Šé™)</small>` : ''}
            </div>
            <button class="delete-btn" title="åˆªé™¤æ­¤äººå“¡" onclick="deletePersonnel(${p.id})"><span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span><span class="delete-fallback" style="display:none;">åˆªé™¤</span></button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.person-name-input').forEach(input => {
        new CustomAutocomplete(input, 'person');
        input.onchange = function() {
            const id = parseInt(this.dataset.id);
            updatePersonnel(id, 'name', this.value);
            addCommonInfo('person', this.value);
        };
    });
    list.querySelectorAll('.person-mealcost-input').forEach(input => { input.oninput = function() { updatePersonnel(parseInt(this.dataset.id), 'mealCost', parseFloat(this.value) || 0); }; });
    list.querySelectorAll('.person-discount-type').forEach(sel => { sel.onchange = function() { updatePersonnel(parseInt(this.dataset.id), 'discount.type', this.value); renderPersonnel(); }; });
    list.querySelectorAll('.person-discount-value').forEach(input => { input.oninput = function() { updatePersonnel(parseInt(this.dataset.id), 'discount.value', parseFloat(this.value) || 0); }; });
    list.querySelectorAll('.person-discount-cap').forEach(input => { input.oninput = function() { updatePersonnel(parseInt(this.dataset.id), 'discount.cap', parseFloat(this.value) || 0); }; });
}

function renderSharedCosts() {
    const list = document.getElementById('shared-costs-list');
    list.innerHTML = '';
    mealCostData.appData.sharedCosts.forEach(sc => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-cost';
        div.dataset.id = sc.id;
        div.draggable = true;
        div.innerHTML = `
            <label>è²»ç”¨åç¨±: <div class="autocomplete-container"><input type="text" value="${sc.name}" class="shared-cost-name-input" data-id="${sc.id}"></div></label>
            <div class="cost-logic">
                <label>è²»ç”¨:</label>
                <select class="shared-cost-type-input" data-id="${sc.id}"><option value="amount" ${sc.cost.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option><option value="percent" ${sc.cost.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option></select>
                <input type="number" min="0" value="${sc.cost.value}" class="shared-cost-value-input" data-id="${sc.id}">
                ${sc.cost.type === 'percent' ? `<label>ä¸Šé™: <input type="number" min="0" value="${sc.cost.cap}" class="shared-cost-cap-input" data-id="${sc.id}"></label><small>(0ç‚ºç„¡ä¸Šé™)</small>` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼: <select class="shared-cost-method-input" data-id="${sc.id}"><option value="evenly" ${sc.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option><option value="proportionally" ${sc.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option></select></label>
            <button class="delete-btn" title="åˆªé™¤æ­¤è²»ç”¨" onclick="deleteSharedCost(${sc.id})"><span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span><span class.delete-fallback" style="display:none;">åˆªé™¤</span></button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.shared-cost-name-input').forEach(input => { new CustomAutocomplete(input, 'cost'); input.addEventListener('change', function() { updateSharedCost(parseInt(this.dataset.id), 'name', this.value); }); });
    list.querySelectorAll('.shared-cost-type-input').forEach(input => { input.addEventListener('change', function() { updateSharedCost(parseInt(this.dataset.id), 'cost.type', this.value); }); });
    list.querySelectorAll('.shared-cost-value-input').forEach(input => { input.addEventListener('input', function() { updateSharedCost(parseInt(this.dataset.id), 'cost.value', parseFloat(this.value) || 0); }); });
    list.querySelectorAll('.shared-cost-cap-input').forEach(input => { input.addEventListener('input', function() { updateSharedCost(parseInt(this.dataset.id), 'cost.cap', parseFloat(this.value) || 0); }); });
    list.querySelectorAll('.shared-cost-method-input').forEach(input => { input.addEventListener('change', function() { updateSharedCost(parseInt(this.dataset.id), 'method', this.value); }); });
}

function renderSharedDiscounts() {
    const list = document.getElementById('shared-discounts-list');
    list.innerHTML = '';
    mealCostData.appData.sharedDiscounts.forEach(sd => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-discount';
        div.dataset.id = sd.id;
        div.draggable = true;
        div.innerHTML = `
            <label>å„ªæƒ åç¨±: <div class="autocomplete-container"><input type="text" value="${sd.name}" class="shared-discount-name-input" data-id="${sd.id}"></div></label>
            <div class="discount-logic">
                <label>å„ªæƒ :</label>
                <select class="shared-discount-type-input" data-id="${sd.id}"><option value="amount" ${sd.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option><option value="percent" ${sd.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option></select>
                <input type="number" min="0" value="${sd.discount.value}" class="shared-discount-value-input" data-id="${sd.id}">
                 ${sd.discount.type === 'percent' ? `<label>ä¸Šé™: <input type="number" min="0" value="${sd.discount.cap}" class="shared-discount-cap-input" data-id="${sd.id}"></label><small>(0ç‚ºç„¡ä¸Šé™)</small>` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼: <select class="shared-discount-method-input" data-id="${sd.id}"><option value="evenly" ${sd.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option><option value="proportionally" ${sd.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option></select></label>
            <button class="delete-btn" title="åˆªé™¤æ­¤å„ªæƒ " onclick="deleteSharedDiscount(${sd.id})"><span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span><span class="delete-fallback" style="display:none;">åˆªé™¤</span></button>
        `;
        list.appendChild(div);
    });

    list.querySelectorAll('.shared-discount-name-input').forEach(input => { new CustomAutocomplete(input, 'discount'); input.addEventListener('change', function() { updateSharedDiscount(parseInt(this.dataset.id), 'name', this.value); }); });
    list.querySelectorAll('.shared-discount-type-input').forEach(input => { input.addEventListener('change', function() { updateSharedDiscount(parseInt(this.dataset.id), 'discount.type', this.value); }); });
    list.querySelectorAll('.shared-discount-value-input').forEach(input => { input.addEventListener('input', function() { updateSharedDiscount(parseInt(this.dataset.id), 'discount.value', parseFloat(this.value) || 0); }); });
    list.querySelectorAll('.shared-discount-cap-input').forEach(input => { input.addEventListener('input', function() { updateSharedDiscount(parseInt(this.dataset.id), 'discount.cap', parseFloat(this.value) || 0); }); });
    list.querySelectorAll('.shared-discount-method-input').forEach(input => { input.addEventListener('change', function() { updateSharedDiscount(parseInt(this.dataset.id), 'method', this.value); }); });
}

// ===== æ‹–æ›³æ’åºå‡½å¼ (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
function setupDrag(listSelector, dataArray) {
    const list = document.querySelector(listSelector);
    let draggedItem = null;
    let placeholder = null;

    list.addEventListener('dragstart', (e) => {
        if (e.target.closest('.item-row')) {
            draggedItem = e.target.closest('.item-row');
            
            placeholder = document.createElement('div');
            placeholder.className = 'item-row placeholder';
            const rect = draggedItem.getBoundingClientRect();
            placeholder.style.height = `${rect.height}px`;

            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }
    });

    list.addEventListener('dragend', () => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
        }
        if (placeholder && placeholder.parentNode) {
            placeholder.remove();
        }
        draggedItem = null;
        placeholder = null;
    });

    list.addEventListener('dragover', e => {
        e.preventDefault();
        if (!placeholder) return;
        const afterElement = getDragAfterElementForRow(list, e.clientY);
        if (afterElement == null) {
            list.appendChild(placeholder);
        } else {
            list.insertBefore(placeholder, afterElement);
        }
    });

    list.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem || !placeholder || !placeholder.parentNode) return;

        placeholder.parentNode.replaceChild(draggedItem, placeholder);
        placeholder = null; 
        
        const newOrder = [...list.querySelectorAll('.item-row')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => dataArray.find(item => item.id === id)).filter(Boolean);
        
        if (dataArray === mealCostData.appData.personnel) mealCostData.appData.personnel = newArr;
        else if (dataArray === mealCostData.appData.sharedCosts) mealCostData.appData.sharedCosts = newArr;
        else if (dataArray === mealCostData.appData.sharedDiscounts) mealCostData.appData.sharedDiscounts = newArr;
        
        saveData();
    });
}

function getDragAfterElementForRow(container, y) {
    const draggableElements = [...container.querySelectorAll('.item-row:not(.dragging):not(.placeholder)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function renderCalculationOrder() {
    const container = document.getElementById('calculation-order-container');
    container.innerHTML = '';
    const nameMap = { personnel: '(+) äººå“¡å€', sharedDiscounts: '(-) å…±åŒå„ªæƒ å€', sharedCosts: '(+) å‡åˆ†è²»ç”¨å€' };
    mealCostData.appData.calculationOrder.forEach(key => {
        const div = document.createElement('div');
        div.className = 'order-block';
        div.dataset.key = key;
        div.draggable = true;
        div.textContent = nameMap[key];
        container.appendChild(div);
    });
}

function renderSettings() {
    document.getElementById('decimal-places').value = mealCostData.appData.settings.decimalPlaces;
    document.getElementById('rounding-method').value = mealCostData.appData.settings.roundingMethod || 'round';
    document.getElementById('show-steps-toggle').checked = !!mealCostData.appData.settings.showSteps;
    document.getElementById('confirm-delete-item-toggle').checked = !!mealCostData.appData.settings.confirmDeleteItem;
    document.getElementById('confirm-delete-option-toggle').checked = !!mealCostData.appData.settings.confirmDeleteOption;
    document.getElementById('calc-steps').style.display = mealCostData.appData.settings.showSteps ? 'block' : 'none';
}

// ===== è¨ˆç®—é †åºå€çš„æ‹–æ›³å‡½å¼ (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
function getDragAfterElementForHorizontal(container, x) {
    const draggableElements = [...container.querySelectorAll('.order-block:not(.dragging):not(.placeholder)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
        else { return closest; }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function setupOrderDragAndDrop() {
    const container = document.getElementById('calculation-order-container');
    let draggedItem = null;
    let placeholder = null;

    container.addEventListener('dragstart', e => {
        if (e.target.classList.contains('order-block')) {
            draggedItem = e.target;
            placeholder = document.createElement('div');
            placeholder.className = 'order-block placeholder';
            const rect = draggedItem.getBoundingClientRect();
            placeholder.style.width = `${rect.width}px`;
            placeholder.style.height = `${rect.height}px`;
            setTimeout(() => { draggedItem.classList.add('dragging'); }, 0);
        }
    });

    container.addEventListener('dragend', () => {
        if (draggedItem) { draggedItem.classList.remove('dragging'); }
        if (placeholder && placeholder.parentNode) { placeholder.remove(); }
        draggedItem = null;
        placeholder = null;
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        if (!placeholder) return;
        const afterElement = getDragAfterElementForHorizontal(container, e.clientX);
        if (afterElement == null) { container.appendChild(placeholder); } 
        else { container.insertBefore(placeholder, afterElement); }
    });
    
    container.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedItem || !placeholder || !placeholder.parentNode) return;
        placeholder.parentNode.replaceChild(draggedItem, placeholder);
        placeholder = null;
        mealCostData.appData.calculationOrder = [...container.querySelectorAll('.order-block')].map(b => b.dataset.key);
        saveData();
    });
}

// ===== å…¶é¤˜å‡½å¼ (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
function updateSettings(key, value) { mealCostData.appData.settings[key] = value; saveData(); renderSettings(); }
function addPersonnel() { mealCostData.appData.personnel.push({ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }); saveData(); renderPersonnel(); }
function clearPersonnel() { if (confirm('ç¢ºå®šè¦æ¸…ç©ºã€Œåƒèˆ‡è€…/ç”¨é¤äººå£«ã€æ‰€æœ‰é …ç›®å—ï¼Ÿ')) { mealCostData.appData.personnel = [{ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }]; saveData(); renderPersonnel(); } }
function deletePersonnel(id) { if (mealCostData.appData.settings.confirmDeleteItem && !confirm(`ç¢ºå®šè¦åˆªé™¤æ­¤äººå“¡å—ï¼Ÿ`)) return; mealCostData.appData.personnel = mealCostData.appData.personnel.filter(p => p.id !== id); saveData(); renderPersonnel(); }
function updatePersonnel(id, field, value) {
    const person = mealCostData.appData.personnel.find(p => p.id === id);
    if (!person) return;
    if (field.includes('.')) { const [obj, prop] = field.split('.'); person[obj][prop] = value; } 
    else { person[field] = value; }
    saveData();
}
function addSharedCost() { mealCostData.appData.sharedCosts.push({ id: Date.now(), name: '', cost: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' }); saveData(); renderSharedCosts(); }
function clearSharedCosts() { if (confirm('ç¢ºå®šè¦æ¸…ç©ºã€Œå‡åˆ†è²»ç”¨å€ã€æ‰€æœ‰é …ç›®å—ï¼Ÿ')) { mealCostData.appData.sharedCosts = []; saveData(); renderSharedCosts(); } }
function deleteSharedCost(id) { if (mealCostData.appData.settings.confirmDeleteItem && !confirm(`ç¢ºå®šè¦åˆªé™¤æ­¤è²»ç”¨å—ï¼Ÿ`)) return; mealCostData.appData.sharedCosts = mealCostData.appData.sharedCosts.filter(sc => sc.id !== id); saveData(); renderSharedCosts(); }
function updateSharedCost(id, field, value) {
    const cost = mealCostData.appData.sharedCosts.find(sc => sc.id === id);
    if (!cost) return;
    if (field.includes('.')) { const [obj, prop] = field.split('.'); cost[obj][prop] = value; } 
    else { cost[field] = value; }
    if (field === 'name') addCommonInfo('cost', value);
    saveData();
    if (field === 'cost.type') renderSharedCosts();
}
function addSharedDiscount() { mealCostData.appData.sharedDiscounts.push({ id: Date.now(), name: '', discount: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' }); saveData(); renderSharedDiscounts(); }
function clearSharedDiscounts() { if (confirm('ç¢ºå®šè¦æ¸…ç©ºã€Œå…±åŒå„ªæƒ å€ã€æ‰€æœ‰é …ç›®å—ï¼Ÿ')) { mealCostData.appData.sharedDiscounts = []; saveData(); renderSharedDiscounts(); } }
function deleteSharedDiscount(id) { if (mealCostData.appData.settings.confirmDeleteItem && !confirm(`ç¢ºå®šè¦åˆªé™¤æ­¤å„ªæƒ å—ï¼Ÿ`)) return; mealCostData.appData.sharedDiscounts = mealCostData.appData.sharedDiscounts.filter(sd => sd.id !== id); saveData(); renderSharedDiscounts(); }
function updateSharedDiscount(id, field, value) {
    const discount = mealCostData.appData.sharedDiscounts.find(sd => sd.id === id);
    if (!discount) return;
    if (field.includes('.')) { const [obj, prop] = field.split('.'); discount[obj][prop] = value; } 
    else { discount[field] = value; }
    if (field === 'name') addCommonInfo('discount', value);
    saveData();
    if (field === 'discount.type') renderSharedDiscounts();
}
function calculate() {
    const stepsLog = []; const aggregatedPersonnel = {};
    mealCostData.appData.personnel.forEach(p => {
        const name = p.name.trim() || 'æœªå‘½å';
        if (!aggregatedPersonnel[name]) { aggregatedPersonnel[name] = { name: name, baseMealCost: 0, finalAmount: 0 }; }
        let cost = p.mealCost; let discountAmount = 0;
        if (p.discount.type === 'amount') { discountAmount = p.discount.value; } 
        else if (p.discount.type === 'percent') { discountAmount = cost * (p.discount.value / 100); if (p.discount.cap > 0 && discountAmount > p.discount.cap) discountAmount = p.discount.cap; }
        stepsLog.push(`äººå“¡ã€Œ${name}ã€é …ç›®ï¼šé¤è²» ${cost}` + (discountAmount > 0 ? ` - æŠ˜æ‰£ ${discountAmount} = ${Math.max(cost - discountAmount, 0)}` : ''));
        aggregatedPersonnel[name].baseMealCost += cost;
        aggregatedPersonnel[name].finalAmount += (cost - discountAmount);
    });
    let results = Object.values(aggregatedPersonnel);
    if (results.length === 0) { alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½äººå“¡ï¼'); return; }
    const totalBaseMealCost = results.reduce((sum, p) => sum + p.baseMealCost, 0);
    stepsLog.push(`é¤è²»å°è¨ˆ(æŠ˜æ‰£å¾Œ)ï¼š` + results.map(r => `${r.name}:${(r.finalAmount).toFixed(2)}`).join('ï¼Œ'));
    mealCostData.appData.calculationOrder.forEach(step => {
        if (step === 'sharedDiscounts') {
            let currentTotalBeforeDiscount = results.reduce((sum, r) => sum + r.finalAmount, 0);
            stepsLog.push('å¥—ç”¨å…±åŒå„ªæƒ ï¼š');
            processSharedDiscounts(results, totalBaseMealCost, currentTotalBeforeDiscount, stepsLog);
        } else if (step === 'sharedCosts') {
            stepsLog.push('åŠ å…¥å‡åˆ†è²»ç”¨ï¼š');
            processSharedCosts(results, totalBaseMealCost, stepsLog);
        }
    });
    displayResults(results, stepsLog);
}
function processSharedDiscounts(results, totalBaseMealCost, currentTotal, stepsLog) {
    mealCostData.appData.sharedDiscounts.forEach(sd => {
        let totalDiscountValue = 0;
        if (sd.discount.type === 'amount') { totalDiscountValue = sd.discount.value; } 
        else { totalDiscountValue = currentTotal * (sd.discount.value / 100); if (sd.discount.cap > 0 && totalDiscountValue > sd.discount.cap) totalDiscountValue = sd.discount.cap; }
        stepsLog.push(`- ${sd.name || 'æœªå‘½åå„ªæƒ '}... åˆè¨ˆæŠ˜æ‰£ ${totalDiscountValue.toFixed(2)}`);
        if (sd.method === 'evenly') { if (results.length > 0) { const discountPerPerson = totalDiscountValue / results.length; results.forEach(r => r.finalAmount -= discountPerPerson); stepsLog.push(`  å¹³å‡æ”¤åˆ†ï¼Œæ¯äºº -${discountPerPerson.toFixed(2)}`); } } 
        else { if (totalBaseMealCost > 0) { results.forEach(r => { const proportion = r.baseMealCost / totalBaseMealCost; const d = (totalDiscountValue * proportion); r.finalAmount -= d; stepsLog.push(`  ${r.name} æŒ‰æ¯”ä¾‹ -${d.toFixed(2)}`); }); } }
        currentTotal = results.reduce((sum, r) => sum + r.finalAmount, 0);
    });
}
function processSharedCosts(results, totalBaseMealCost, stepsLog) {
    mealCostData.appData.sharedCosts.forEach(sc => {
        let totalCostValue = 0;
        if (sc.cost.type === 'amount') { totalCostValue = sc.cost.value; } 
        else { totalCostValue = totalBaseMealCost * (sc.cost.value / 100); if (sc.cost.cap > 0 && totalCostValue > sc.cost.cap) totalCostValue = sc.cost.cap; }
        stepsLog.push(`- ${sc.name || 'æœªå‘½åè²»ç”¨'}... åˆè¨ˆè²»ç”¨ ${totalCostValue.toFixed(2)}`);
        if (sc.method === 'evenly') { if (results.length > 0) { const costPerPerson = totalCostValue / results.length; results.forEach(r => r.finalAmount += costPerPerson); stepsLog.push(`  å¹³å‡æ”¤åˆ†ï¼Œæ¯äºº +${costPerPerson.toFixed(2)}`); } } 
        else { if (totalBaseMealCost > 0) { results.forEach(r => { const proportion = r.baseMealCost / totalBaseMealCost; const c = (totalCostValue * proportion); r.finalAmount += c; stepsLog.push(`  ${r.name} æŒ‰æ¯”ä¾‹ +${c.toFixed(2)}`); }); } }
    });
}
function displayResults(results, stepsLog = []) {
    const detailsDiv = document.getElementById('result-details');
    const grandTotalP = document.getElementById('grand-total');
    const stepsUl = document.getElementById('calc-steps');
    const { decimalPlaces, roundingMethod } = mealCostData.appData.settings;
    const multiplier = 10 ** decimalPlaces;
    function roundValue(val) {
        if (roundingMethod === 'ceil') return Math.ceil(val * multiplier) / multiplier;
        if (roundingMethod === 'floor') return Math.floor(val * multiplier) / multiplier;
        return Math.round(val * multiplier) / multiplier;
    }
    stepsUl.innerHTML = '';
    if (mealCostData.appData.settings.showSteps && stepsLog.length) { stepsLog.forEach(t => { const li = document.createElement('li'); li.textContent = t; stepsUl.appendChild(li); }); }
    detailsDiv.innerHTML = '';
    let grandTotal = 0;
    results.forEach(r => {
        const finalAmountRounded = roundValue(Math.max(0, r.finalAmount));
        grandTotal += finalAmountRounded;
        const p = document.createElement('p');
        p.textContent = `${r.name} æ‡‰ä»˜: $ ${finalAmountRounded.toFixed(decimalPlaces)}`;
        detailsDiv.appendChild(p);
    });
    grandTotalP.textContent = `æ”¶æ¬¾ç¸½è¨ˆ: $ ${grandTotal.toFixed(decimalPlaces)}`;
}
function addCommonInfo(type, name) { name = (name || '').trim(); if (!name) return; if (!mealCostData.commonInfo[type].includes(name)) { mealCostData.commonInfo[type].push(name); saveData(); } }
function deleteCommonInfoItem(type, idx, callback) {
    if (mealCostData.appData.settings.confirmDeleteOption) { if (!confirm(`ç¢ºå®šè¦åˆªé™¤å¸¸ç”¨é …ç›®ã€Œ${mealCostData.commonInfo[type][idx]}ã€å—ï¼Ÿ`)) return; }
    mealCostData.commonInfo[type].splice(idx, 1);
    saveData();
    if (callback) callback();
}
function syncCommonInfoFromAppData() {
    mealCostData.appData.personnel.forEach(p => addCommonInfo('person', p.name));
    mealCostData.appData.sharedCosts.forEach(sc => addCommonInfo('cost', sc.name));
    mealCostData.appData.sharedDiscounts.forEach(sd => addCommonInfo('discount', sd.name));
}

// ===== åˆå§‹åŒ– (å·²æ›´æ–°ä»¥ä½¿ç”¨ mealCostData) =====
document.addEventListener('DOMContentLoaded', () => {
    // æª¢æŸ¥ emoji æ”¯æ´
    function supportsEmoji(char) { const span = document.createElement('span'); span.textContent = char; return span.textContent === char && span.innerText === char; }
    if (!supportsEmoji('ğŸ—‘ï¸')) { document.querySelectorAll('.delete-icon').forEach(e => e.style.display = 'none'); document.querySelectorAll('.delete-fallback').forEach(e => e.style.display = 'inline'); }
    if (!supportsEmoji('ğŸ§¹')) { document.querySelectorAll('.clear-icon').forEach(e => e.style.display = 'none'); document.querySelectorAll('.clear-fallback').forEach(e => e.style.display = 'inline'); }

    // Modal äº‹ä»¶ç¶å®š
    const modal = document.getElementById('common-info-modal');
    document.getElementById('settings-btn').onclick = () => { modal.style.display = 'flex'; };
    document.querySelector('#common-info-modal .close-modal').onclick = () => modal.style.display = 'none';
    window.onclick = (event) => { if (event.target === modal) modal.style.display = 'none'; };
    
    // å¾ç¾æœ‰è³‡æ–™åŒæ­¥å¸¸ç”¨è©
    syncCommonInfoFromAppData();

    // ä¸€æ¬¡æ€§è¨­å®šå¥½æ‰€æœ‰æ‹–æ›³åŠŸèƒ½
    setupDrag('#personnel-list', mealCostData.appData.personnel);
    setupDrag('#shared-costs-list', mealCostData.appData.sharedCosts);
    setupDrag('#shared-discounts-list', mealCostData.appData.sharedDiscounts);
    setupOrderDragAndDrop();

    // é¦–æ¬¡æ¸²æŸ“
    render();
});
</script>

</body>
</html>
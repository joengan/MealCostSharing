<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤è²»è¨ˆç®—æ©Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            max-width: 1080px;
            margin: 0 auto;
        }
        .container {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        .item-row input, .item-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .item-row input[type="text"] { flex-grow: 1; min-width: 100px; }
        .item-row input[type="number"] { width: 100px; }
        .discount-logic, .cost-logic { /* Added .cost-logic */
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background-color: transparent;
            color: #d32f2f;
            border: none;
            padding: 8px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover { background-color: #ffeaea; }
        .delete-icon {
            font-size: 18px;
            line-height: 1;
        }
        .delete-fallback {
            font-size: 14px;
            color: white;
            background-color: #f44336;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .add-btn, .calc-btn, .temp-save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .add-btn:hover, .calc-btn:hover, .temp-save-btn:hover { background-color: #45a049; }
        .temp-save-btn {
            background-color: #008CBA;
            margin-left: 10px;
        }
        .temp-save-btn:hover { background-color: #007ba7; }
        
        #calculation-order-container {
            display: flex;
            gap: 15px;
            padding: 10px;
            border: 1px dashed #aaa;
            border-radius: 5px;
        }
        .order-block {
            padding: 15px 25px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            user-select: none;
            border: 2px solid #ccc;
        }
        .order-block.dragging { opacity: 0.5; background: #b0b0b0; }
        
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4CAF50;
            border-radius: 5px;
        }
        #results h3 { margin-top: 0; }
        #results p { margin: 5px 0; font-size: 1.1em; }
        #results #grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #d32f2f;
            margin-top: 15px;
        }
        .save-feedback {
            color: #4CAF50;
            font-style: italic;
            margin-left: 15px;
            display: none;
        }
        .settings-area { margin-bottom: 15px; }
        .settings-area label { font-weight: bold; }
        .settings-area input { width: 60px; }
    </style>
</head>
<body>

<div class="container">
    <h1>é¤è²»è¨ˆç®—æ©Ÿ</h1>

    <div class="section">
        <h2>1. åƒèˆ‡è€…/ç”¨é¤äººå£« (åŒåäººå“¡é …ç›®æœƒè‡ªå‹•åˆä½µè¨ˆç®—)</h2>
        <div id="personnel-list"></div>
    <button class="add-btn" onclick="addPersonnel()">æ–°å¢é …ç›®</button>
    </div>

    <div class="section">
        <h2>2. å‡åˆ†è²»ç”¨å€</h2>
        <div id="shared-costs-list"></div>
    <button class="add-btn" onclick="addSharedCost()">æ–°å¢å‡åˆ†è²»ç”¨</button>
    </div>

    <div class="section">
        <h2>3. å…±åŒå„ªæƒ å€</h2>
        <div id="shared-discounts-list"></div>
    <button class="add-btn" onclick="addSharedDiscount()">æ–°å¢å…±åŒå„ªæƒ </button>
    </div>
    
    <div class="section">
        <h2>4. è¨ˆç®—æ–¹å¼ (å¯æ‹–æ›³èª¿æ•´é †åº)</h2>
        <div id="calculation-order-container"></div>
    </div>

    <div class="section">
        <h2>5. é€²è¡Œè¨ˆç®—</h2>
        <div class="settings-area">
            <label>å°æ•¸ä½æ•¸: 
                <input type="number" id="decimal-places" min="0" max="10" 
                       oninput="updateSettings('decimalPlaces', parseInt(this.value))">
            </label>
        </div>
        <button class="calc-btn" onclick="calculate()">è¨ˆç®—</button>
        <div id="results">
            <h3>è¨ˆç®—çµæœ</h3>
            <div id="result-details">-- ç­‰å¾…è¨ˆç®— --</div>
            <p id="grand-total"></p>
        </div>
    </div>
</div>

<script>
const STORAGE_KEY = 'splitBillCalculatorData_v2';

// é è¨­è³‡æ–™çµæ§‹
const defaultData = {
    personnel: [{ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }],
    sharedCosts: [],
    sharedDiscounts: [],
    calculationOrder: ['personnel', 'sharedDiscounts', 'sharedCosts'],
    settings: {
        decimalPlaces: 1
    }
};

let appData = loadData();

// ===== è³‡æ–™è™•ç† (å­˜/è®€) =====
function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        console.log('Data saved to localStorage.');
    } catch (e) {
        console.error("Error saving data to localStorage:", e);
        alert('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼');
    }
}

function loadData() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
        try {
            const savedData = JSON.parse(data);
            
            // **[MODIFIED]** Handle migration for old sharedCosts format
            if (savedData.sharedCosts && savedData.sharedCosts.length > 0) {
                savedData.sharedCosts.forEach(sc => {
                    if (typeof sc.amount !== 'undefined' && typeof sc.cost === 'undefined') {
                        sc.cost = { type: 'amount', value: sc.amount, cap: 0 };
                        delete sc.amount;
                    }
                });
            }

            return {
                ...defaultData,
                ...savedData,
                settings: { ...defaultData.settings, ...(savedData.settings || {}) }
            };
        } catch (e) {
            console.error("Error parsing data from localStorage:", e);
            return JSON.parse(JSON.stringify(defaultData));
        }
    }
    return JSON.parse(JSON.stringify(defaultData));
}

// ===== æ¸²æŸ“ç•«é¢ =====
function render() {
    renderPersonnel();
    renderSharedCosts();
    renderSharedDiscounts();
    renderCalculationOrder();
    renderSettings();
}

function renderPersonnel() {
    const list = document.getElementById('personnel-list');
    list.innerHTML = '';
    // åˆ†çµ„ï¼šåŒåèšé›†
    const groupMap = {};
    appData.personnel.forEach(p => {
        const name = p.name.trim() || 'æœªå‘½å';
        if (!groupMap[name]) groupMap[name] = [];
        groupMap[name].push(p);
    });
    Object.keys(groupMap).forEach((name, idx) => {
        // group header
        const groupDiv = document.createElement('div');
        groupDiv.className = 'item-row';
        groupDiv.style.background = '#f0f0f0';
        groupDiv.style.cursor = 'pointer';
        groupDiv.style.fontWeight = 'bold';
    groupDiv.innerHTML = `<span>${name} (${groupMap[name].length})</span>`;
    groupDiv.onclick = function() { toggleGroup(name); };
    list.appendChild(groupDiv);
        // group items
        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'personnel-group-items';
        itemsDiv.dataset.group = name;
        itemsDiv.style.marginLeft = '20px';
        itemsDiv.style.display = window.personnelGroupState?.[name] === false ? 'none' : 'block';
        groupMap[name].forEach(p => {
            const div = document.createElement('div');
            div.className = 'item-row draggable-personnel';
            div.dataset.id = p.id;
            div.draggable = true;
            div.innerHTML = `
                <label>å§“å: <input type="text" value="${p.name}" class="person-name-input" data-id="${p.id}"></label>
                <label>é¤è²»: <input type="number" min="0" value="${p.mealCost}" class="person-mealcost-input" data-id="${p.id}"></label>
                <div class="discount-logic">
                    <label>æŠ˜æ‰£:</label>
                    <select class="person-discount-type" data-id="${p.id}">
                        <option value="amount" ${p.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                        <option value="percent" ${p.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                    </select>
                    <input type="number" min="0" value="${p.discount.value}" class="person-discount-value" data-id="${p.id}">
                    ${p.discount.type === 'percent' ? `
                        <label>ä¸Šé™: <input type="number" min="0" value="${p.discount.cap}" class="person-discount-cap" data-id="${p.id}"></label>
                        <small>(0ç‚ºç„¡ä¸Šé™)</small>
                    ` : ''}
                </div>
                <button class="delete-btn" onclick="deletePersonnel(${p.id})">
                  <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
                  <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
                </button>
            `;
    // çµ±ä¸€ç›£è½ input äº‹ä»¶
    setTimeout(() => {
        // å§“å input onchange
        list.querySelectorAll('.person-name-input').forEach(input => {
            input.onchange = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'name', this.value);
                renderPersonnel(); // ç«‹å³åˆ†çµ„
            };
        });
        // é¤è²» input oninput
        list.querySelectorAll('.person-mealcost-input').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'mealCost', parseFloat(this.value) || 0);
            };
        });
        // æŠ˜æ‰£å‹æ…‹ select onchange
        list.querySelectorAll('.person-discount-type').forEach(sel => {
            sel.onchange = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.type', this.value);
                renderPersonnel();
            };
        });
        // æŠ˜æ‰£å€¼ input oninput
        list.querySelectorAll('.person-discount-value').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.value', parseFloat(this.value) || 0);
            };
        });
        // æŠ˜æ‰£ä¸Šé™ input oninput
        list.querySelectorAll('.person-discount-cap').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.cap', parseFloat(this.value) || 0);
            };
        });
    }, 0);
            itemsDiv.appendChild(div);
        });
        list.appendChild(itemsDiv);
    });
    setupPersonnelDragAndDrop();
}
// å±•é–‹/æ”¶åˆåˆ†çµ„
window.personnelGroupState = {};
function toggleGroup(name) {
    window.personnelGroupState[name] = window.personnelGroupState[name] === false ? true : false;
    renderPersonnel();
}

// æ‹–æ›³æ’åºï¼ˆåˆ†çµ„å…§ï¼‰
function setupPersonnelDragAndDrop() {
    const groups = document.querySelectorAll('.personnel-group-items');
    groups.forEach(itemsDiv => {
        let draggedItem = null;
        const draggables = itemsDiv.querySelectorAll('.draggable-personnel');
        draggables.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                setTimeout(() => item.classList.add('dragging'), 0);
            });
            item.addEventListener('dragend', () => {
                if (draggedItem) draggedItem.classList.remove('dragging');
                draggedItem = null;
            });
        });
        itemsDiv.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(itemsDiv, e.clientY);
            if (draggedItem) {
                if (afterElement == null) itemsDiv.appendChild(draggedItem);
                else itemsDiv.insertBefore(draggedItem, afterElement);
            }
        });
        itemsDiv.addEventListener('drop', e => {
            e.preventDefault();
            // å–å¾—æ–°é †åº
            const newOrder = [...itemsDiv.querySelectorAll('.draggable-personnel')].map(div => parseInt(div.dataset.id));
            // åªèª¿æ•´è©²åˆ†çµ„
            const groupName = itemsDiv.dataset.group;
            const oldGroup = appData.personnel.filter(p => (p.name.trim() || 'æœªå‘½å') === groupName);
            const other = appData.personnel.filter(p => (p.name.trim() || 'æœªå‘½å') !== groupName);
            const newGroup = newOrder.map(id => oldGroup.find(p => p.id === id)).filter(Boolean);
            appData.personnel = [...other, ...newGroup];
            saveData();
            renderPersonnel();
        });
    });
}

// **[MODIFIED]** - Updated to handle new cost structure (amount/percent)
function renderSharedCosts() {
    const list = document.getElementById('shared-costs-list');
    list.innerHTML = '';
    appData.sharedCosts.forEach(sc => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-cost';
        div.dataset.id = sc.id;
        div.draggable = true;
        div.innerHTML = `
            <label>è²»ç”¨åç¨±: <input type="text" value="${sc.name}" oninput="updateSharedCost(${sc.id}, 'name', this.value)"></label>
            <div class="cost-logic">
                <label>è²»ç”¨:</label>
                <select onchange="updateSharedCost(${sc.id}, 'cost.type', this.value)">
                    <option value="amount" ${sc.cost.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                    <option value="percent" ${sc.cost.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                </select>
                <input type="number" min="0" value="${sc.cost.value}" oninput="updateSharedCost(${sc.id}, 'cost.value', parseFloat(this.value) || 0)">
                ${sc.cost.type === 'percent' ? `
                    <label>ä¸Šé™: <input type="number" min="0" value="${sc.cost.cap}" oninput="updateSharedCost(${sc.id}, 'cost.cap', parseFloat(this.value) || 0)"></label>
                    <small>(0ç‚ºç„¡ä¸Šé™)</small>
                ` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼:
                <select onchange="updateSharedCost(${sc.id}, 'method', this.value)">
                    <option value="evenly" ${sc.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option>
                    <option value="proportionally" ${sc.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option>
                </select>
            </label>
            <button class="delete-btn" onclick="deleteSharedCost(${sc.id})">
              <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
              <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
            </button>
        `;
        list.appendChild(div);
    });
    setupSharedCostDragAndDrop();
}
// æ‹–æ›³æ’åºï¼ˆå‡åˆ†è²»ç”¨å€ï¼‰
function setupSharedCostDragAndDrop() {
    const list = document.getElementById('shared-costs-list');
    let draggedItem = null;
    const draggables = list.querySelectorAll('.draggable-shared-cost');
    draggables.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (draggedItem) {
            if (afterElement == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, afterElement);
        }
    });
    list.addEventListener('drop', e => {
        e.preventDefault();
        // å–å¾—æ–°é †åº
        const newOrder = [...list.querySelectorAll('.draggable-shared-cost')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => appData.sharedCosts.find(sc => sc.id === id)).filter(Boolean);
        appData.sharedCosts = newArr;
        saveData();
        renderSharedCosts();
    });
}

function renderSharedDiscounts() {
    const list = document.getElementById('shared-discounts-list');
    list.innerHTML = '';
    appData.sharedDiscounts.forEach(sd => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-discount';
        div.dataset.id = sd.id;
        div.draggable = true;
        div.innerHTML = `
            <label>å„ªæƒ åç¨±: <input type="text" value="${sd.name}" oninput="updateSharedDiscount(${sd.id}, 'name', this.value)"></label>
            <div class="discount-logic">
                <label>å„ªæƒ :</label>
                <select onchange="updateSharedDiscount(${sd.id}, 'discount.type', this.value)">
                    <option value="amount" ${sd.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                    <option value="percent" ${sd.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                </select>
                <input type="number" min="0" value="${sd.discount.value}" oninput="updateSharedDiscount(${sd.id}, 'discount.value', parseFloat(this.value) || 0)">
                 ${sd.discount.type === 'percent' ? `
                    <label>ä¸Šé™: <input type="number" min="0" value="${sd.discount.cap}" oninput="updateSharedDiscount(${sd.id}, 'discount.cap', parseFloat(this.value) || 0)"></label>
                    <small>(0ç‚ºç„¡ä¸Šé™)</small>
                ` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼:
                <select onchange="updateSharedDiscount(${sd.id}, 'method', this.value)">
                    <option value="evenly" ${sd.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option>
                    <option value="proportionally" ${sd.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option>
                </select>
            </label>
            <button class="delete-btn" onclick="deleteSharedDiscount(${sd.id})">
              <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
              <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
            </button>
        `;
        list.appendChild(div);
    });
    setupSharedDiscountDragAndDrop();
}
// æ‹–æ›³æ’åºï¼ˆå…±åŒå„ªæƒ å€ï¼‰
function setupSharedDiscountDragAndDrop() {
    const list = document.getElementById('shared-discounts-list');
    let draggedItem = null;
    const draggables = list.querySelectorAll('.draggable-shared-discount');
    draggables.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (draggedItem) {
            if (afterElement == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, afterElement);
        }
    });
    list.addEventListener('drop', e => {
        e.preventDefault();
        // å–å¾—æ–°é †åº
        const newOrder = [...list.querySelectorAll('.draggable-shared-discount')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => appData.sharedDiscounts.find(sd => sd.id === id)).filter(Boolean);
        appData.sharedDiscounts = newArr;
        saveData();
        renderSharedDiscounts();
    });
}

function renderCalculationOrder() {
    const container = document.getElementById('calculation-order-container');
    container.innerHTML = '';
    const nameMap = {
        personnel: '(+) äººå“¡å€',
        sharedDiscounts: '(-) å…±åŒå„ªæƒ å€',
        sharedCosts: '(+) å‡åˆ†è²»ç”¨å€'
    };
    appData.calculationOrder.forEach(key => {
        const div = document.createElement('div');
        div.className = 'order-block';
        div.dataset.key = key;
        div.draggable = true;
        div.textContent = nameMap[key];
        container.appendChild(div);
    });
    setupDragAndDrop();
}

function renderSettings() {
    document.getElementById('decimal-places').value = appData.settings.decimalPlaces;
}

// ===== å‹•æ…‹å¢åˆªæ”¹ & è¨­å®š =====
function updateSettings(key, value) {
    if (isNaN(value) || value < 0) value = 1;
    if (value > 10) value = 10;
    appData.settings[key] = value;
    document.getElementById('decimal-places').value = value;
    saveData();
}

function addPersonnel() {
    appData.personnel.push({ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } });
    saveData();
    renderPersonnel();
}
function deletePersonnel(id) {
    appData.personnel = appData.personnel.filter(p => p.id !== id);
    saveData();
    renderPersonnel();
}
function updatePersonnel(id, field, value) {
    const person = appData.personnel.find(p => p.id === id);
    if (!person) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        person[obj][prop] = value;
    } else {
        person[field] = value;
    }
    saveData();
    if (field === 'discount.type') {
       renderPersonnel();
    }
}
// **[MODIFIED]** - Add new shared cost with the new data structure
function addSharedCost() {
    appData.sharedCosts.push({ id: Date.now(), name: '', cost: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' });
    saveData();
    renderSharedCosts();
}
function deleteSharedCost(id) {
    appData.sharedCosts = appData.sharedCosts.filter(sc => sc.id !== id);
    saveData();
    renderSharedCosts();
}
// **[MODIFIED]** - Update shared cost for nested properties and re-render on type change
function updateSharedCost(id, field, value) {
    const cost = appData.sharedCosts.find(sc => sc.id === id);
    if (!cost) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        cost[obj][prop] = value;
    } else {
        cost[field] = value;
    }
    saveData();
    if (field === 'cost.type') {
       renderSharedCosts();
    }
}
function addSharedDiscount() {
    appData.sharedDiscounts.push({ id: Date.now(), name: '', discount: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' });
    saveData();
    renderSharedDiscounts();
}
function deleteSharedDiscount(id) {
    appData.sharedDiscounts = appData.sharedDiscounts.filter(sd => sd.id !== id);
    saveData();
    renderSharedDiscounts();
}
function updateSharedDiscount(id, field, value) {
    const discount = appData.sharedDiscounts.find(sd => sd.id === id);
    if (!discount) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        discount[obj][prop] = value;
    } else {
        discount[field] = value;
    }
    saveData();
    if (field === 'discount.type') {
       renderSharedDiscounts();
    }
}

// ===== æ‹–æ›³æ’åºåŠŸèƒ½ =====
function setupDragAndDrop() {
    const container = document.getElementById('calculation-order-container');
    const blocks = document.querySelectorAll('.order-block');
    let draggedItem = null;

    blocks.forEach(block => {
        block.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });
        block.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientX);
        if (draggedItem) {
            if (afterElement == null) container.appendChild(draggedItem);
            else container.insertBefore(draggedItem, afterElement);
        }
    });
    
    container.addEventListener('drop', e => {
        e.preventDefault();
        const newOrder = [...container.querySelectorAll('.order-block')].map(b => b.dataset.key);
        appData.calculationOrder = newOrder;
        saveData();
    });
}
function getDragAfterElement(container, yOrX) {
    // æ”¯æ´ order-block (æ©«å‘) èˆ‡ personnel (ç¸±å‘)
    const draggableElements = [...container.querySelectorAll(':scope > .draggable-personnel:not(.dragging), :scope > .order-block:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        // æ©«å‘æ‹–æ›³ç”¨ xï¼Œç¸±å‘æ‹–æ›³ç”¨ y
        const offset = (child.classList.contains('order-block'))
            ? yOrX - box.left - box.width / 2
            : yOrX - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ===== è¨ˆç®—é‚è¼¯ =====
function calculate() {
    // 1. åˆä½µåŒåäººå“¡è³‡æ–™
    const aggregatedPersonnel = {};
    appData.personnel.forEach(p => {
        const name = p.name.trim() || 'æœªå‘½å';
        if (!aggregatedPersonnel[name]) {
            aggregatedPersonnel[name] = {
                name: name,
                baseMealCost: 0, // ç¸½é¤è²»(æŠ˜æ‰£å‰)
                finalAmount: 0   // å€‹äººé …ç›®çµç®—å¾Œé‡‘é¡
            };
        }
        
        let cost = p.mealCost;
        let discountAmount = 0;
        if (p.discount.type === 'amount') {
            discountAmount = p.discount.value;
        } else if (p.discount.type === 'percent') {
            discountAmount = cost * (p.discount.value / 100);
            if (p.discount.cap > 0 && discountAmount > p.discount.cap) {
                discountAmount = p.discount.cap;
            }
        }
        
        aggregatedPersonnel[name].baseMealCost += cost;
        aggregatedPersonnel[name].finalAmount += (cost - discountAmount);
    });

    let results = Object.values(aggregatedPersonnel);

    if (results.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½äººå“¡ï¼');
        return;
    }
    
    const totalBaseMealCost = results.reduce((sum, p) => sum + p.baseMealCost, 0);

    // 2. ä¾ç…§é †åºè™•ç†å…±åŒé …ç›®
    appData.calculationOrder.forEach(step => {
        if (step === 'sharedDiscounts') {
            let currentTotalBeforeDiscount = results.reduce((sum, r) => sum + r.finalAmount, 0);
            processSharedDiscounts(results, totalBaseMealCost, currentTotalBeforeDiscount);
        } else if (step === 'sharedCosts') {
            processSharedCosts(results, totalBaseMealCost);
        }
    });

    // 3. é¡¯ç¤ºçµæœ
    displayResults(results);
}

function processSharedDiscounts(results, totalBaseMealCost, currentTotal) {
    appData.sharedDiscounts.forEach(sd => {
        let totalDiscountValue = 0;
        if (sd.discount.type === 'amount') {
            totalDiscountValue = sd.discount.value;
        } else { // percent
            totalDiscountValue = currentTotal * (sd.discount.value / 100);
            if (sd.discount.cap > 0 && totalDiscountValue > sd.discount.cap) {
                totalDiscountValue = sd.discount.cap;
            }
        }

        if (sd.method === 'evenly') {
            if (results.length > 0) {
                const discountPerPerson = totalDiscountValue / results.length;
                results.forEach(r => r.finalAmount -= discountPerPerson);
            }
        } else { // proportionally
            if (totalBaseMealCost > 0) {
                results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
                    r.finalAmount -= (totalDiscountValue * proportion);
                });
            }
        }
    });
}

// **[MODIFIED]** - Updated calculation logic for shared costs
function processSharedCosts(results, totalBaseMealCost) {
    appData.sharedCosts.forEach(sc => {
        let totalCostValue = 0;
        if (sc.cost.type === 'amount') {
            totalCostValue = sc.cost.value;
        } else { // percent
            // Percentage cost is based on the total base meal cost
            totalCostValue = totalBaseMealCost * (sc.cost.value / 100);
            if (sc.cost.cap > 0 && totalCostValue > sc.cost.cap) {
                totalCostValue = sc.cost.cap;
            }
        }

        if (sc.method === 'evenly') {
            if (results.length > 0) {
                const costPerPerson = totalCostValue / results.length;
                results.forEach(r => r.finalAmount += costPerPerson);
            }
        } else { // proportionally
            if (totalBaseMealCost > 0) {
                 results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
                    r.finalAmount += (totalCostValue * proportion);
                });
            }
        }
    });
}

function displayResults(results) {
    const detailsDiv = document.getElementById('result-details');
    const grandTotalP = document.getElementById('grand-total');
    const decimalPlaces = appData.settings.decimalPlaces;
    const multiplier = 10 ** decimalPlaces;
    
    detailsDiv.innerHTML = '';
    let grandTotal = 0;

    results.forEach(r => {
        const finalAmount = r.finalAmount < 0 ? 0 : r.finalAmount;
        const finalAmountRounded = Math.round(finalAmount * multiplier) / multiplier;
        grandTotal += finalAmountRounded;

        const p = document.createElement('p');
        p.textContent = `${r.name} æ‡‰ä»˜: $ ${finalAmountRounded.toFixed(decimalPlaces)}`;
        detailsDiv.appendChild(p);
    });

    grandTotalP.textContent = `æ”¶æ¬¾ç¸½è¨ˆ: $ ${grandTotal.toFixed(decimalPlaces)}`;
}

// ===== å…¶ä»– UI åŠŸèƒ½ =====
function showSaveFeedback(button) {
    saveData();
    const feedback = button.nextElementSibling;
    feedback.style.display = 'inline';
    setTimeout(() => { feedback.style.display = 'none'; }, 1500);
}

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    render();
});

// æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ emoji ğŸ—‘ï¸ï¼Œä¸æ”¯æ´å‰‡é¡¯ç¤ºæ–‡å­—
function supportsTrashEmoji() {
    const span = document.createElement('span');
    span.innerHTML = 'ğŸ—‘ï¸';
    return span.innerHTML.length > 0 && span.innerText === 'ğŸ—‘ï¸';
}
document.addEventListener('DOMContentLoaded', function() {
    if (!supportsTrashEmoji()) {
        document.querySelectorAll('.delete-icon').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.delete-fallback').forEach(e => e.style.display = 'inline');
    }
});
</script>

</body>
</html>
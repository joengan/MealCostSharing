<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤è²»è¨ˆç®—æ©Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            max-width: 1080px;
            margin: 0 auto;
        }
        .container {
            position: relative;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        .item-row input, .item-row select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .item-row input[type="text"] { flex-grow: 1; min-width: 100px; }
        .item-row input[type="number"] { width: 100px; }
        .discount-logic, .cost-logic { /* Added .cost-logic */
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background-color: transparent;
            color: #d32f2f;
            border: none;
            padding: 8px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover { background-color: #ffeaea; }
        .delete-icon {
            font-size: 18px;
            line-height: 1;
        }
        .delete-fallback {
            font-size: 14px;
            color: white;
            background-color: #f44336;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .add-btn, .calc-btn, .temp-save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .calc-btn {
            width: 100%;
        }
        .add-btn:hover, .calc-btn:hover, .temp-save-btn:hover { background-color: #45a049; }
        .temp-save-btn {
            background-color: #008CBA;
            margin-left: 10px;
        }
        .temp-save-btn:hover { background-color: #007ba7; }
        
        #calculation-order-container {
            display: flex;
            gap: 15px;
            padding: 10px;
            border: 1px dashed #aaa;
            border-radius: 5px;
        }
        .order-block {
            padding: 15px 25px;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: move;
            text-align: center;
            user-select: none;
            border: 2px solid #ccc;
        }
        .order-block.dragging { opacity: 0.5; background: #b0b0b0; }
        
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4CAF50;
            border-radius: 5px;
        }
        #results h3 { margin-top: 0; }
        #results p { margin: 5px 0; font-size: 1.1em; }
        #results #grand-total {
            font-weight: bold;
            font-size: 1.3em;
            color: #d32f2f;
            margin-top: 15px;
        }
        .save-feedback {
            color: #4CAF50;
            font-style: italic;
            margin-left: 15px;
            display: none;
        }
        .settings-area { margin-bottom: 15px; }
    .settings-area label { font-weight: bold; }
    .settings-area input { width: 60px; }

    /* Switch styles (åƒè€ƒç”¨) */
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
    .switch input:checked + .slider { background-color: #2196F3; }
    .switch input:checked + .slider:before { transform: translateX(26px); }

    /* æ­¥é©Ÿåˆ—è¡¨æ¨£å¼ */
    .steps { margin: 6px 0 10px 0; padding-left: 16px; color: #2f4f4f; }
    .steps li { margin: 2px 0; }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 30px 30px 20px 30px;
            border-radius: 10px;
            min-width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 28px;
            cursor: pointer;
        }
        .common-list-block { margin-bottom: 18px; }
        .common-list { list-style: none; padding: 0; margin: 0; }
        .common-list li {
            background: #f7f7f7;
            margin-bottom: 6px;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            justify-content: space-between;
        }
        .common-list li.dragging { opacity: 0.5; background: #e0e0e0; }
        .common-list .delete-btn {
            background: none;
            color: #d32f2f;
            font-size: 18px;
            border: none;
            cursor: pointer;
            padding: 0 6px;
        }
        
        #settings-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 28px;
            cursor: pointer;
            z-index: 20;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>é¤è²»è¨ˆç®—æ©Ÿ</h1>

    <div class="section">
        <h2>1. åƒèˆ‡è€…/ç”¨é¤äººå£« (åŒåäººå“¡é …ç›®æœƒè‡ªå‹•åˆä½µè¨ˆç®—)</h2>
        <div id="personnel-list"></div>
    <button class="add-btn" onclick="addPersonnel()">æ–°å¢é …ç›®</button>
    </div>

    <div class="section">
        <h2>2. å‡åˆ†è²»ç”¨å€</h2>
        <div id="shared-costs-list"></div>
    <button class="add-btn" onclick="addSharedCost()">æ–°å¢å‡åˆ†è²»ç”¨</button>
    </div>

    <div class="section">
        <h2>3. å…±åŒå„ªæƒ å€</h2>
        <div id="shared-discounts-list"></div>
    <button class="add-btn" onclick="addSharedDiscount()">æ–°å¢å…±åŒå„ªæƒ </button>
    </div>
    
    <div class="section">
        <h2>4. è¨ˆç®—æ–¹å¼ (å¯æ‹–æ›³èª¿æ•´é †åº)</h2>
        <div id="calculation-order-container"></div>
    </div>

    <div class="section">
        <h2>5. é€²è¡Œè¨ˆç®—</h2>
        <div class="settings-area">
            <label>é€²ä½æ–¹å¼:
                <select id="rounding-method" onchange="updateSettings('roundingMethod', this.value)">
                    <option value="round">å››æ¨äº”å…¥</option>
                    <option value="ceil">ä¸Šæ¨å…¥</option>
                    <option value="floor">ä¸‹æ¨å…¥</option>
                </select>
            </label>
            <label style="margin-left: 18px;">å°æ•¸ä½æ•¸: 
                <input type="number" id="decimal-places" min="0" max="10" 
                       oninput="updateSettings('decimalPlaces', parseInt(this.value))">
            </label>
            <span style="margin-left: 18px;">
                <span style="font-weight:bold; vertical-align: middle;">é¡¯ç¤ºè¨ˆç®—éç¨‹</span>
                <label class="switch" style="margin-left:8px;">
                    <input type="checkbox" id="show-steps-toggle" onchange="updateSettings('showSteps', this.checked)">
                    <span class="slider"></span>
                </label>
            </span>
        </div>
        <button class="calc-btn" onclick="calculate()">è¨ˆç®—</button>
        <div id="results">
            <h3>è¨ˆç®—çµæœ</h3>
            <ul id="calc-steps" class="steps" style="display:none;"></ul>
            <div id="result-details">-- ç­‰å¾…è¨ˆç®— --</div>
            <p id="grand-total"></p>
        </div>
    </div>

    <div id="settings-btn" title="å¸¸ç”¨è³‡è¨Šç®¡ç†">âš™ï¸</div>
    <div id="common-info-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-modal" title="é—œé–‰">&times;</span>
        <h2>å¸¸ç”¨è³‡è¨Šç®¡ç†</h2>
        <div class="common-list-block">
          <h3>äººå“¡åç¨±</h3>
          <ul id="common-person-list" class="common-list"></ul>
        </div>
        <div class="common-list-block">
          <h3>è²»ç”¨åç¨±</h3>
          <ul id="common-cost-list" class="common-list"></ul>
        </div>
        <div class="common-list-block">
          <h3>å„ªæƒ åç¨±</h3>
          <ul id="common-discount-list" class="common-list"></ul>
        </div>
      </div>
    </div>

    <datalist id="common-person-datalist"></datalist>
    <datalist id="common-cost-datalist"></datalist>
    <datalist id="common-discount-datalist"></datalist>
</div>

<script>
const STORAGE_KEY = 'splitBillCalculatorData_v2';

// é è¨­è³‡æ–™çµæ§‹
const defaultData = {
    personnel: [{ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } }],
    sharedCosts: [],
    sharedDiscounts: [],
    calculationOrder: ['personnel', 'sharedDiscounts', 'sharedCosts'],
    settings: {
        decimalPlaces: 1,
    roundingMethod: 'round', // æ–°å¢é€²ä½æ–¹å¼ï¼Œé è¨­å››æ¨äº”å…¥
    showSteps: false
    }
};

let appData = loadData();

// ===== è³‡æ–™è™•ç† (å­˜/è®€) =====
function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        console.log('Data saved to localStorage.');
    } catch (e) {
        console.error("Error saving data to localStorage:", e);
        alert('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼');
    }
}

function loadData() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
        try {
            const savedData = JSON.parse(data);
            
            // **[MODIFIED]** Handle migration for old sharedCosts format
            if (savedData.sharedCosts && savedData.sharedCosts.length > 0) {
                savedData.sharedCosts.forEach(sc => {
                    if (typeof sc.amount !== 'undefined' && typeof sc.cost === 'undefined') {
                        sc.cost = { type: 'amount', value: sc.amount, cap: 0 };
                        delete sc.amount;
                    }
                });
            }

            return {
                ...defaultData,
                ...savedData,
                settings: { ...defaultData.settings, ...(savedData.settings || {}) }
            };
        } catch (e) {
            console.error("Error parsing data from localStorage:", e);
            return JSON.parse(JSON.stringify(defaultData));
        }
    }
    return JSON.parse(JSON.stringify(defaultData));
}

// ===== æ¸²æŸ“ç•«é¢ =====
function render() {
    renderPersonnel();
    renderSharedCosts();
    renderSharedDiscounts();
    renderCalculationOrder();
    renderSettings();
}

function renderPersonnel() {
    const list = document.getElementById('personnel-list');
    list.innerHTML = '';
    appData.personnel.forEach(p => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-personnel';
        div.dataset.id = p.id;
        div.draggable = true;
        div.innerHTML = `
            <label>å§“å: <input type="text" value="${p.name}" class="person-name-input" data-id="${p.id}" list="common-person-datalist"></label>
            <label>é¤è²»: <input type="number" min="0" value="${p.mealCost}" class="person-mealcost-input" data-id="${p.id}"></label>
            <div class="discount-logic">
                <label>æŠ˜æ‰£:</label>
                <select class="person-discount-type" data-id="${p.id}">
                    <option value="amount" ${p.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                    <option value="percent" ${p.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                </select>
                <input type="number" min="0" value="${p.discount.value}" class="person-discount-value" data-id="${p.id}">
                ${p.discount.type === 'percent' ? `
                    <label>ä¸Šé™: <input type="number" min="0" value="${p.discount.cap}" class="person-discount-cap" data-id="${p.id}"></label>
                    <small>(0ç‚ºç„¡ä¸Šé™)</small>
                ` : ''}
            </div>
            <button class="delete-btn" onclick="deletePersonnel(${p.id})">
              <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
              <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
            </button>
        `;
        list.appendChild(div);
    });
    // çµ±ä¸€ç›£è½ input äº‹ä»¶
    setTimeout(() => {
        list.querySelectorAll('.person-name-input').forEach(input => {
            input.onchange = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'name', this.value);
                addCommonInfo('person', this.value);
                updateCommonDatalists();
                renderPersonnel();
            };
        });
        list.querySelectorAll('.person-mealcost-input').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'mealCost', parseFloat(this.value) || 0);
            };
        });
        list.querySelectorAll('.person-discount-type').forEach(sel => {
            sel.onchange = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.type', this.value);
                renderPersonnel();
            };
        });
        list.querySelectorAll('.person-discount-value').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.value', parseFloat(this.value) || 0);
            };
        });
        list.querySelectorAll('.person-discount-cap').forEach(input => {
            input.oninput = function() {
                const id = parseInt(this.dataset.id);
                updatePersonnel(id, 'discount.cap', parseFloat(this.value) || 0);
            };
        });
    }, 0);
    setupPersonnelDragAndDrop();
}


// æ‹–æ›³æ’åºï¼ˆäººå“¡å€ï¼‰
function setupPersonnelDragAndDrop() {
    const list = document.getElementById('personnel-list');
    let draggedItem = null;
    const draggables = list.querySelectorAll('.draggable-personnel');
    draggables.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (draggedItem) {
            if (afterElement == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, afterElement);
        }
    });
    list.addEventListener('drop', e => {
        e.preventDefault();
        // å–å¾—æ–°é †åº
        const newOrder = [...list.querySelectorAll('.draggable-personnel')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => appData.personnel.find(p => p.id === id)).filter(Boolean);
        appData.personnel = newArr;
        saveData();
        renderPersonnel();
    });
}

// **[MODIFIED]** - Updated to handle new cost structure (amount/percent)
function renderSharedCosts() {
    const list = document.getElementById('shared-costs-list');
    list.innerHTML = '';
    appData.sharedCosts.forEach(sc => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-cost';
        div.dataset.id = sc.id;
        div.draggable = true;
        div.innerHTML = `
            <label>è²»ç”¨åç¨±: <input type="text" value="${sc.name}" onchange="updateSharedCost(${sc.id}, 'name', this.value)" list="common-cost-datalist"></label>
            <div class="cost-logic">
                <label>è²»ç”¨:</label>
                <select onchange="updateSharedCost(${sc.id}, 'cost.type', this.value)">
                    <option value="amount" ${sc.cost.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                    <option value="percent" ${sc.cost.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                </select>
                <input type="number" min="0" value="${sc.cost.value}" oninput="updateSharedCost(${sc.id}, 'cost.value', parseFloat(this.value) || 0)">
                ${sc.cost.type === 'percent' ? `
                    <label>ä¸Šé™: <input type="number" min="0" value="${sc.cost.cap}" oninput="updateSharedCost(${sc.id}, 'cost.cap', parseFloat(this.value) || 0)"></label>
                    <small>(0ç‚ºç„¡ä¸Šé™)</small>
                ` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼:
                <select onchange="updateSharedCost(${sc.id}, 'method', this.value)">
                    <option value="evenly" ${sc.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option>
                    <option value="proportionally" ${sc.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option>
                </select>
            </label>
            <button class="delete-btn" onclick="deleteSharedCost(${sc.id})">
              <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
              <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
            </button>
        `;
        list.appendChild(div);
    });
    setupSharedCostDragAndDrop();
}
// æ‹–æ›³æ’åºï¼ˆå‡åˆ†è²»ç”¨å€ï¼‰
function setupSharedCostDragAndDrop() {
    const list = document.getElementById('shared-costs-list');
    let draggedItem = null;
    const draggables = list.querySelectorAll('.draggable-shared-cost');
    draggables.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (draggedItem) {
            if (afterElement == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, afterElement);
        }
    });
    list.addEventListener('drop', e => {
        e.preventDefault();
        // å–å¾—æ–°é †åº
        const newOrder = [...list.querySelectorAll('.draggable-shared-cost')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => appData.sharedCosts.find(sc => sc.id === id)).filter(Boolean);
        appData.sharedCosts = newArr;
        saveData();
        renderSharedCosts();
    });
}

function renderSharedDiscounts() {
    const list = document.getElementById('shared-discounts-list');
    list.innerHTML = '';
    appData.sharedDiscounts.forEach(sd => {
        const div = document.createElement('div');
        div.className = 'item-row draggable-shared-discount';
        div.dataset.id = sd.id;
        div.draggable = true;
        div.innerHTML = `
            <label>å„ªæƒ åç¨±: <input type="text" value="${sd.name}" onchange="updateSharedDiscount(${sd.id}, 'name', this.value)" list="common-discount-datalist"></label>
            <div class="discount-logic">
                <label>å„ªæƒ :</label>
                <select onchange="updateSharedDiscount(${sd.id}, 'discount.type', this.value)">
                    <option value="amount" ${sd.discount.type === 'amount' ? 'selected' : ''}>é‡‘é¡</option>
                    <option value="percent" ${sd.discount.type === 'percent' ? 'selected' : ''}>æ¯”ä¾‹(%)</option>
                </select>
                <input type="number" min="0" value="${sd.discount.value}" oninput="updateSharedDiscount(${sd.id}, 'discount.value', parseFloat(this.value) || 0)">
                 ${sd.discount.type === 'percent' ? `
                    <label>ä¸Šé™: <input type="number" min="0" value="${sd.discount.cap}" oninput="updateSharedDiscount(${sd.id}, 'discount.cap', parseFloat(this.value) || 0)"></label>
                    <small>(0ç‚ºç„¡ä¸Šé™)</small>
                ` : ''}
            </div>
            <label>æ”¤åˆ†æ–¹å¼:
                <select onchange="updateSharedDiscount(${sd.id}, 'method', this.value)">
                    <option value="evenly" ${sd.method === 'evenly' ? 'selected' : ''}>å¹³å‡æ”¤åˆ†</option>
                    <option value="proportionally" ${sd.method === 'proportionally' ? 'selected' : ''}>æŒ‰é¤è²»æ¯”ä¾‹</option>
                </select>
            </label>
            <button class="delete-btn" onclick="deleteSharedDiscount(${sd.id})">
              <span class="delete-icon" aria-label="åˆªé™¤" role="img">ğŸ—‘ï¸</span>
              <span class="delete-fallback" style="display:none;">åˆªé™¤</span>
            </button>
        `;
        list.appendChild(div);
    });
    setupSharedDiscountDragAndDrop();
}
// æ‹–æ›³æ’åºï¼ˆå…±åŒå„ªæƒ å€ï¼‰
function setupSharedDiscountDragAndDrop() {
    const list = document.getElementById('shared-discounts-list');
    let draggedItem = null;
    const draggables = list.querySelectorAll('.draggable-shared-discount');
    draggables.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    list.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (draggedItem) {
            if (afterElement == null) list.appendChild(draggedItem);
            else list.insertBefore(draggedItem, afterElement);
        }
    });
    list.addEventListener('drop', e => {
        e.preventDefault();
        // å–å¾—æ–°é †åº
        const newOrder = [...list.querySelectorAll('.draggable-shared-discount')].map(div => parseInt(div.dataset.id));
        const newArr = newOrder.map(id => appData.sharedDiscounts.find(sd => sd.id === id)).filter(Boolean);
        appData.sharedDiscounts = newArr;
        saveData();
        renderSharedDiscounts();
    });
}

function renderCalculationOrder() {
    const container = document.getElementById('calculation-order-container');
    container.innerHTML = '';
    const nameMap = {
        personnel: '(+) äººå“¡å€',
        sharedDiscounts: '(-) å…±åŒå„ªæƒ å€',
        sharedCosts: '(+) å‡åˆ†è²»ç”¨å€'
    };
    appData.calculationOrder.forEach(key => {
        const div = document.createElement('div');
        div.className = 'order-block';
        div.dataset.key = key;
        div.draggable = true;
        div.textContent = nameMap[key];
        container.appendChild(div);
    });
    setupDragAndDrop();
}

function renderSettings() {
    document.getElementById('decimal-places').value = appData.settings.decimalPlaces;
    document.getElementById('rounding-method').value = appData.settings.roundingMethod || 'round';
    const showSteps = !!appData.settings.showSteps;
    const toggle = document.getElementById('show-steps-toggle');
    if (toggle) toggle.checked = showSteps;
    const ul = document.getElementById('calc-steps');
    if (ul) ul.style.display = showSteps ? 'block' : 'none';
}

// ===== å‹•æ…‹å¢åˆªæ”¹ & è¨­å®š =====
function updateSettings(key, value) {
    if (key === 'decimalPlaces') {
        if (isNaN(value) || value < 0) value = 1;
        if (value > 10) value = 10;
        appData.settings[key] = value;
        document.getElementById('decimal-places').value = value;
    } else if (key === 'roundingMethod') {
        appData.settings[key] = value;
        document.getElementById('rounding-method').value = value;
    } else if (key === 'showSteps') {
        appData.settings[key] = !!value;
        const ul = document.getElementById('calc-steps');
        if (ul) ul.style.display = appData.settings[key] ? 'block' : 'none';
    }
    saveData();
}

function addPersonnel() {
    appData.personnel.push({ id: Date.now(), name: '', mealCost: 0, discount: { type: 'amount', value: 0, cap: 0 } });
    saveData();
    renderPersonnel();
}
function deletePersonnel(id) {
    appData.personnel = appData.personnel.filter(p => p.id !== id);
    saveData();
    renderPersonnel();
}
function updatePersonnel(id, field, value) {
    const person = appData.personnel.find(p => p.id === id);
    if (!person) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        person[obj][prop] = value;
    } else {
        person[field] = value;
    }
    saveData();
    if (field === 'discount.type') {
       renderPersonnel();
    }
}
// **[MODIFIED]** - Add new shared cost with the new data structure
function addSharedCost() {
    appData.sharedCosts.push({ id: Date.now(), name: '', cost: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' });
    saveData();
    renderSharedCosts();
}
function deleteSharedCost(id) {
    appData.sharedCosts = appData.sharedCosts.filter(sc => sc.id !== id);
    saveData();
    renderSharedCosts();
}
// **[MODIFIED]** - Update shared cost for nested properties and re-render on type change
function updateSharedCost(id, field, value) {
    const cost = appData.sharedCosts.find(sc => sc.id === id);
    if (!cost) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        cost[obj][prop] = value;
    } else {
        cost[field] = value;
    }
    if (field === 'name') {
        addCommonInfo('cost', value);
        updateCommonDatalists();
    }
    saveData();
    if (field === 'cost.type') {
       renderSharedCosts();
    }
}
function addSharedDiscount() {
    appData.sharedDiscounts.push({ id: Date.now(), name: '', discount: { type: 'amount', value: 0, cap: 0 }, method: 'evenly' });
    saveData();
    renderSharedDiscounts();
}
function deleteSharedDiscount(id) {
    appData.sharedDiscounts = appData.sharedDiscounts.filter(sd => sd.id !== id);
    saveData();
    renderSharedDiscounts();
}
function updateSharedDiscount(id, field, value) {
    const discount = appData.sharedDiscounts.find(sd => sd.id === id);
    if (!discount) return;
    if (field.includes('.')) {
        const [obj, prop] = field.split('.');
        discount[obj][prop] = value;
    } else {
        discount[field] = value;
    }
    if (field === 'name') {
        addCommonInfo('discount', value);
        updateCommonDatalists();
    }
    saveData();
    if (field === 'discount.type') {
       renderSharedDiscounts();
    }
}

// ===== æ‹–æ›³æ’åºåŠŸèƒ½ =====
function setupDragAndDrop() {
    const container = document.getElementById('calculation-order-container');
    const blocks = document.querySelectorAll('.order-block');
    let draggedItem = null;

    blocks.forEach(block => {
        block.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });
        block.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientX);
        if (draggedItem) {
            if (afterElement == null) container.appendChild(draggedItem);
            else container.insertBefore(draggedItem, afterElement);
        }
    });
    
    container.addEventListener('drop', e => {
        e.preventDefault();
        const newOrder = [...container.querySelectorAll('.order-block')].map(b => b.dataset.key);
        appData.calculationOrder = newOrder;
        saveData();
    });
}
function getDragAfterElement(container, yOrX) {
    // æ”¯æ´ order-block (æ©«å‘) èˆ‡ personnel (ç¸±å‘)
    const draggableElements = [...container.querySelectorAll(':scope > .draggable-personnel:not(.dragging), :scope > .order-block:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        // æ©«å‘æ‹–æ›³ç”¨ xï¼Œç¸±å‘æ‹–æ›³ç”¨ y
        const offset = (child.classList.contains('order-block'))
            ? yOrX - box.left - box.width / 2
            : yOrX - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ===== è¨ˆç®—é‚è¼¯ =====
function calculate() {
    const stepsLog = [];
    // 1. åˆä½µåŒåäººå“¡è³‡æ–™
    const aggregatedPersonnel = {};
    appData.personnel.forEach(p => {
        const name = p.name.trim() || 'æœªå‘½å';
        if (!aggregatedPersonnel[name]) {
            aggregatedPersonnel[name] = {
                name: name,
                baseMealCost: 0, // ç¸½é¤è²»(æŠ˜æ‰£å‰)
                finalAmount: 0   // å€‹äººé …ç›®çµç®—å¾Œé‡‘é¡
            };
        }
        
        let cost = p.mealCost;
        let discountAmount = 0;
        if (p.discount.type === 'amount') {
            discountAmount = p.discount.value;
        } else if (p.discount.type === 'percent') {
            discountAmount = cost * (p.discount.value / 100);
            if (p.discount.cap > 0 && discountAmount > p.discount.cap) {
                discountAmount = p.discount.cap;
            }
        }
        if (discountAmount > 0) {
            stepsLog.push(`äººå“¡ã€Œ${name}ã€é …ç›®ï¼šé¤è²» ${cost} - æŠ˜æ‰£ ${discountAmount} = ${Math.max(cost - discountAmount, 0)}`);
        } else {
            stepsLog.push(`äººå“¡ã€Œ${name}ã€é …ç›®ï¼šé¤è²» ${cost}`);
        }
        aggregatedPersonnel[name].baseMealCost += cost;
        aggregatedPersonnel[name].finalAmount += (cost - discountAmount);
    });

    let results = Object.values(aggregatedPersonnel);

    if (results.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½äººå“¡ï¼');
        return;
    }
    
    const totalBaseMealCost = results.reduce((sum, p) => sum + p.baseMealCost, 0);
    stepsLog.push(`é¤è²»å°è¨ˆ(æŠ˜æ‰£å¾Œ)ï¼š` + results.map(r => `${r.name}:${(r.finalAmount).toFixed(2)}`).join('ï¼Œ'));

    // 2. ä¾ç…§é †åºè™•ç†å…±åŒé …ç›®
    appData.calculationOrder.forEach(step => {
        if (step === 'sharedDiscounts') {
            let currentTotalBeforeDiscount = results.reduce((sum, r) => sum + r.finalAmount, 0);
            stepsLog.push('å¥—ç”¨å…±åŒå„ªæƒ ï¼š');
            processSharedDiscounts(results, totalBaseMealCost, currentTotalBeforeDiscount, stepsLog);
        } else if (step === 'sharedCosts') {
            stepsLog.push('åŠ å…¥å‡åˆ†è²»ç”¨ï¼š');
            processSharedCosts(results, totalBaseMealCost, stepsLog);
        }
    });

    // 3. é¡¯ç¤ºçµæœ
    displayResults(results, stepsLog);
}

function processSharedDiscounts(results, totalBaseMealCost, currentTotal, stepsLog) {
    appData.sharedDiscounts.forEach(sd => {
        let totalDiscountValue = 0;
        if (sd.discount.type === 'amount') {
            totalDiscountValue = sd.discount.value;
        } else { // percent
            totalDiscountValue = currentTotal * (sd.discount.value / 100);
            if (sd.discount.cap > 0 && totalDiscountValue > sd.discount.cap) {
                totalDiscountValue = sd.discount.cap;
            }
        }
    if (stepsLog) stepsLog.push(`- ${sd.name || 'æœªå‘½åå„ªæƒ '}ï¼š${sd.discount.type === 'amount' ? 'é‡‘é¡' : 'æ¯”ä¾‹'} ${sd.discount.value}${sd.discount.type === 'percent' ? '%' : ''}${sd.discount.cap>0 ? ` (ä¸Šé™ ${sd.discount.cap})` : ''}ï¼Œåˆè¨ˆæŠ˜æ‰£ ${totalDiscountValue.toFixed(2)}`);

        if (sd.method === 'evenly') {
            if (results.length > 0) {
                const discountPerPerson = totalDiscountValue / results.length;
        results.forEach(r => r.finalAmount -= discountPerPerson);
        if (stepsLog) stepsLog.push(`  å¹³å‡æ”¤åˆ†ï¼Œæ¯äºº -${discountPerPerson.toFixed(2)}`);
            }
        } else { // proportionally
            if (totalBaseMealCost > 0) {
                results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
            const d = (totalDiscountValue * proportion);
            r.finalAmount -= d;
            if (stepsLog) stepsLog.push(`  ${r.name} æŒ‰æ¯”ä¾‹ -${d.toFixed(2)} (å æ¯” ${(proportion*100).toFixed(2)}%)`);
                });
            }
        }
    // æ›´æ–°ç•¶å‰ç¸½é¡ï¼Œä¾›é€£çºŒç™¾åˆ†æ¯”å„ªæƒ ä½¿ç”¨
    currentTotal = results.reduce((sum, r) => sum + r.finalAmount, 0);
    });
}

// **[MODIFIED]** - Updated calculation logic for shared costs
function processSharedCosts(results, totalBaseMealCost, stepsLog) {
    appData.sharedCosts.forEach(sc => {
        let totalCostValue = 0;
        if (sc.cost.type === 'amount') {
            totalCostValue = sc.cost.value;
        } else { // percent
            // Percentage cost is based on the total base meal cost
            totalCostValue = totalBaseMealCost * (sc.cost.value / 100);
            if (sc.cost.cap > 0 && totalCostValue > sc.cost.cap) {
                totalCostValue = sc.cost.cap;
            }
        }
        if (stepsLog) stepsLog.push(`- ${sc.name || 'æœªå‘½åè²»ç”¨'}ï¼š${sc.cost.type === 'amount' ? 'é‡‘é¡' : 'æ¯”ä¾‹'} ${sc.cost.value}${sc.cost.type === 'percent' ? '%' : ''}${sc.cost.cap>0 ? ` (ä¸Šé™ ${sc.cost.cap})` : ''}ï¼Œåˆè¨ˆè²»ç”¨ ${totalCostValue.toFixed(2)}`);

        if (sc.method === 'evenly') {
            if (results.length > 0) {
                const costPerPerson = totalCostValue / results.length;
                results.forEach(r => r.finalAmount += costPerPerson);
                if (stepsLog) stepsLog.push(`  å¹³å‡æ”¤åˆ†ï¼Œæ¯äºº +${costPerPerson.toFixed(2)}`);
            }
        } else { // proportionally
            if (totalBaseMealCost > 0) {
                 results.forEach(r => {
                    const proportion = r.baseMealCost / totalBaseMealCost;
                    const c = (totalCostValue * proportion);
                    r.finalAmount += c;
                    if (stepsLog) stepsLog.push(`  ${r.name} æŒ‰æ¯”ä¾‹ +${c.toFixed(2)} (å æ¯” ${(proportion*100).toFixed(2)}%)`);
                });
            }
        }
    });
}

function displayResults(results, stepsLog = []) {
    const detailsDiv = document.getElementById('result-details');
    const grandTotalP = document.getElementById('grand-total');
    const stepsUl = document.getElementById('calc-steps');
    const decimalPlaces = appData.settings.decimalPlaces;
    const multiplier = 10 ** decimalPlaces;
    const roundingMethod = appData.settings.roundingMethod || 'round';

    function roundValue(val) {
        if (roundingMethod === 'ceil') {
            return Math.ceil(val * multiplier) / multiplier;
        } else if (roundingMethod === 'floor') {
            return Math.floor(val * multiplier) / multiplier;
        } else {
            return Math.round(val * multiplier) / multiplier;
        }
    }

    // é¡¯ç¤ºæ­¥é©Ÿ
    if (stepsUl) {
        stepsUl.innerHTML = '';
        if (appData.settings.showSteps && stepsLog && stepsLog.length) {
            stepsUl.style.display = 'block';
            stepsLog.forEach(t => {
                const li = document.createElement('li');
                li.textContent = t;
                stepsUl.appendChild(li);
            });
        } else {
            stepsUl.style.display = appData.settings.showSteps ? 'block' : 'none';
        }
    }

    detailsDiv.innerHTML = '';
    let grandTotal = 0;

    results.forEach(r => {
        const finalAmount = r.finalAmount < 0 ? 0 : r.finalAmount;
        const finalAmountRounded = roundValue(finalAmount);
        grandTotal += finalAmountRounded;

        const p = document.createElement('p');
        p.textContent = `${r.name} æ‡‰ä»˜: $ ${finalAmountRounded.toFixed(decimalPlaces)}`;
        detailsDiv.appendChild(p);
    });

    grandTotalP.textContent = `æ”¶æ¬¾ç¸½è¨ˆ: $ ${grandTotal.toFixed(decimalPlaces)}`;
}

// ===== å…¶ä»– UI åŠŸèƒ½ =====
function showSaveFeedback(button) {
    saveData();
    const feedback = button.nextElementSibling;
    feedback.style.display = 'inline';
    setTimeout(() => { feedback.style.display = 'none'; }, 1500);
}

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    render();
    document.getElementById('settings-btn').onclick = showCommonInfoModal;
    document.querySelector('#common-info-modal .close-modal').onclick = hideCommonInfoModal;
    syncCommonInfoFromAppData();
});

// æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ emoji ğŸ—‘ï¸ï¼Œä¸æ”¯æ´å‰‡é¡¯ç¤ºæ–‡å­—
function supportsTrashEmoji() {
    const span = document.createElement('span');
    span.innerHTML = 'ğŸ—‘ï¸';
    return span.innerHTML.length > 0 && span.innerText === 'ğŸ—‘ï¸';
}
document.addEventListener('DOMContentLoaded', function() {
    if (!supportsTrashEmoji()) {
        document.querySelectorAll('.delete-icon').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.delete-fallback').forEach(e => e.style.display = 'inline');
    }
});

// ===== å¸¸ç”¨è³‡è¨Šç®¡ç† =====
function renderCommonInfo() {
    renderCommonPersonList();
    renderCommonCostList();
    renderCommonDiscountList();
}

function renderCommonPersonList() {
    const list = document.getElementById('common-person-list');
    list.innerHTML = '';
    const commonNames = Array.from(new Set(appData.personnel.map(p => p.name.trim()).filter(name => name !== '')));
    commonNames.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = function() { insertCommonPersonName(name); };
        list.appendChild(li);
    });
}

function renderCommonCostList() {
    const list = document.getElementById('common-cost-list');
    list.innerHTML = '';
    const commonCosts = appData.sharedCosts.map(sc => ({ name: sc.name, type: sc.cost.type, value: sc.cost.value, cap: sc.cost.cap }));
    commonCosts.forEach((cost, idx) => {
        const li = document.createElement('li');
        li.textContent = `${cost.name} - ${cost.type === 'amount' ? '$' : ''}${cost.value}${cost.type === 'percent' ? '%' : ''}${cost.cap > 0 ? ' (ä¸Šé™: $' + cost.cap + ')' : ''}`;
        li.onclick = function() { insertCommonCost(cost); };
        list.appendChild(li);
    });
}

function renderCommonDiscountList() {
    const list = document.getElementById('common-discount-list');
    list.innerHTML = '';
    const commonDiscounts = appData.sharedDiscounts.map(sd => ({ name: sd.name, type: sd.discount.type, value: sd.discount.value, cap: sd.discount.cap }));
    commonDiscounts.forEach((discount, idx) => {
        const li = document.createElement('li');
        li.textContent = `${discount.name} - ${discount.type === 'amount' ? '$' : ''}${discount.value}${discount.type === 'percent' ? '%' : ''}${discount.cap > 0 ? ' (ä¸Šé™: $' + discount.cap + ')' : ''}`;
        li.onclick = function() { insertCommonDiscount(discount); };
        list.appendChild(li);
    });
}

// æ’å…¥å¸¸ç”¨è³‡è¨Š
function insertCommonPersonName(name) {
    const input = document.querySelector('.person-name-input');
    if (input) {
        input.value = name;
        const id = parseInt(input.dataset.id);
        updatePersonnel(id, 'name', name);
        renderPersonnel();
    }
}

function insertCommonCost(cost) {
    appData.sharedCosts.push({ id: Date.now(), name: cost.name, cost: { type: cost.type, value: cost.value, cap: cost.cap }, method: 'evenly' });
    saveData();
    renderSharedCosts();
}

function insertCommonDiscount(discount) {
    appData.sharedDiscounts.push({ id: Date.now(), name: discount.name, discount: { type: discount.type, value: discount.value, cap: discount.cap }, method: 'evenly' });
    saveData();
    renderSharedDiscounts();
}

// Modal åŠŸèƒ½
const modal = document.getElementById('common-info-modal');
const settingsBtn = document.getElementById('settings-btn');
const closeModalBtn = document.querySelector('.close-modal');

settingsBtn.onclick = function() {
    modal.style.display = 'block';
    renderCommonInfo();
}

closeModalBtn.onclick = function() {
    modal.style.display = 'none';
}

window.onclick = function(event) {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}

// ===== å¸¸ç”¨è³‡è¨Šç®¡ç†åŠŸèƒ½ =====
const COMMON_KEY = 'splitBillCommonInfo_v1';
function getCommonInfo() {
    const data = localStorage.getItem(COMMON_KEY);
    if (data) {
        try {
            const obj = JSON.parse(data);
            return {
                person: obj.person || [],
                cost: obj.cost || [],
                discount: obj.discount || []
            };
        } catch { }
    }
    return { person: [], cost: [], discount: [] };
}
function saveCommonInfo(info) {
    localStorage.setItem(COMMON_KEY, JSON.stringify(info));
}
let commonInfo = getCommonInfo();

function showCommonInfoModal() {
    document.getElementById('common-info-modal').style.display = 'flex';
    renderCommonInfoLists();
}
function hideCommonInfoModal() {
    document.getElementById('common-info-modal').style.display = 'none';
}
function renderCommonInfoLists() {
    ['person','cost','discount'].forEach(type => {
        const ul = document.getElementById('common-' + type + '-list');
        ul.innerHTML = '';
        commonInfo[type].forEach((name, idx) => {
            const li = document.createElement('li');
            li.draggable = true;
            li.dataset.idx = idx;
            li.innerHTML = `<span>${name}</span><button class='delete-btn' onclick='deleteCommonInfoItem("${type}",${idx})'><span class='delete-icon' aria-label='åˆªé™¤' role='img'>âœ–ï¸</span><span class='delete-fallback' style='display:none;'>åˆªé™¤</span></button>`;
            ul.appendChild(li);
        });
        setupCommonListDragAndDrop(ul, type);
    });
}
function deleteCommonInfoItem(type, idx) {
    commonInfo[type].splice(idx,1);
    saveCommonInfo(commonInfo);
    updateCommonDatalists();
    renderCommonInfoLists();
}
function setupCommonListDragAndDrop(ul, type) {
    let draggedItem = null;
    ul.querySelectorAll('li').forEach(item => {
        item.addEventListener('dragstart', () => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
    });
    ul.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(ul, e.clientY);
        if (draggedItem) {
            if (afterElement == null) ul.appendChild(draggedItem);
            else ul.insertBefore(draggedItem, afterElement);
        }
    });
    ul.addEventListener('drop', e => {
        e.preventDefault();
        const newOrder = [...ul.querySelectorAll('li')].map(li => parseInt(li.dataset.idx));
        const newArr = newOrder.map(i => commonInfo[type][i]);
        commonInfo[type] = newArr;
        saveCommonInfo(commonInfo);
    updateCommonDatalists();
        renderCommonInfoLists();
    });
}

// ===== å¸¸ç”¨è³‡è¨Šè‡ªå‹•å¯«å…¥ =====
function addCommonInfo(type, name) {
    name = (name || '').trim();
    if (!name) return;
    if (!commonInfo[type].includes(name)) {
        commonInfo[type].push(name);
        saveCommonInfo(commonInfo);
    }
}

function updateCommonDatalists() {
    const personDL = document.getElementById('common-person-datalist');
    const costDL = document.getElementById('common-cost-datalist');
    const discountDL = document.getElementById('common-discount-datalist');
    personDL.innerHTML = commonInfo.person.map(n => `<option value="${n}">`).join('');
    costDL.innerHTML = commonInfo.cost.map(n => `<option value="${n}">`).join('');
    discountDL.innerHTML = commonInfo.discount.map(n => `<option value="${n}">`).join('');
}

// åŒæ­¥ç¾æœ‰è³‡æ–™è‡³å¸¸ç”¨è³‡è¨Š
function syncCommonInfoFromAppData() {
    // äººå“¡
    appData.personnel.forEach(p => {
        addCommonInfo('person', p.name);
    });
    // è²»ç”¨
    appData.sharedCosts.forEach(sc => {
        addCommonInfo('cost', sc.name);
    });
    // å„ªæƒ 
    appData.sharedDiscounts.forEach(sd => {
        addCommonInfo('discount', sd.name);
    });
    updateCommonDatalists();
}
</script>

</body>
</html>